<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>cjk_tab_to_h.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">cjk_tab_to_h.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* Copyright (C) 1999-2004, 2006 Free Software Foundation, Inc.
   This file is part of the GNU LIBICONV Tools.

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software Foundation,
   Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */</span>

<span class="enscript-comment">/*
 * Generates a CJK character set table from a .TXT table as found on
 * ftp.unicode.org or in the X nls directory.
 * Examples:
 *
 *   ./cjk_tab_to_h GB2312.1980-0 gb2312 &gt; gb2312.h &lt; gb2312
 *   ./cjk_tab_to_h JISX0208.1983-0 jisx0208 &gt; jisx0208.h &lt; jis0208
 *   ./cjk_tab_to_h KSC5601.1987-0 ksc5601 &gt; ksc5601.h &lt; ksc5601
 *
 *   ./cjk_tab_to_h GB2312.1980-0 gb2312 &gt; gb2312.h &lt; GB2312.TXT
 *   ./cjk_tab_to_h JISX0208.1983-0 jisx0208 &gt; jisx0208.h &lt; JIS0208.TXT
 *   ./cjk_tab_to_h JISX0212.1990-0 jisx0212 &gt; jisx0212.h &lt; JIS0212.TXT
 *   ./cjk_tab_to_h KSC5601.1987-0 ksc5601 &gt; ksc5601.h &lt; KSC5601.TXT
 *   ./cjk_tab_to_h KSX1001.1992-0 ksc5601 &gt; ksc5601.h &lt; KSX1001.TXT
 *
 *   ./cjk_tab_to_h BIG5 big5 &gt; big5.h &lt; BIG5.TXT
 *
 *   ./cjk_tab_to_h JOHAB johab &gt; johab.h &lt; JOHAB.TXT
 *
 *   ./cjk_tab_to_h JISX0213:2004 jisx0213 &gt; jisx0213.h &lt; JISX0213.TXT
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdbool.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ctype.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;assert.h&gt;</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
  <span class="enscript-type">int</span> start;
  <span class="enscript-type">int</span> end;
} Block;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
  <span class="enscript-type">int</span> rows;    <span class="enscript-comment">/* number of possible values for the 1st byte */</span>
  <span class="enscript-type">int</span> cols;    <span class="enscript-comment">/* number of possible values for the 2nd byte */</span>
  <span class="enscript-type">int</span> (*row_byte) (<span class="enscript-type">int</span> row); <span class="enscript-comment">/* returns the 1st byte value for a given row */</span>
  <span class="enscript-type">int</span> (*col_byte) (<span class="enscript-type">int</span> col); <span class="enscript-comment">/* returns the 2nd byte value for a given col */</span>
  <span class="enscript-type">int</span> (*byte_row) (<span class="enscript-type">int</span> byte); <span class="enscript-comment">/* converts a 1st byte value to a row, else -1 */</span>
  <span class="enscript-type">int</span> (*byte_col) (<span class="enscript-type">int</span> byte); <span class="enscript-comment">/* converts a 2nd byte value to a col, else -1 */</span>
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* check_row_expr; <span class="enscript-comment">/* format string for 1st byte value checking */</span>
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* check_col_expr; <span class="enscript-comment">/* format string for 2nd byte value checking */</span>
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* byte_row_expr; <span class="enscript-comment">/* format string for 1st byte value to row */</span>
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* byte_col_expr; <span class="enscript-comment">/* format string for 2nd byte value to col */</span>
  <span class="enscript-type">int</span>** charset2uni; <span class="enscript-comment">/* charset2uni[0..rows-1][0..cols-1] is valid */</span>
  <span class="enscript-comment">/* You'll understand the terms &quot;row&quot; and &quot;col&quot; when you buy Ken Lunde's book.
     Once a row is fixed, choosing a &quot;col&quot; is the same as choosing a &quot;cell&quot;. */</span>
  <span class="enscript-type">int</span>* charsetpage; <span class="enscript-comment">/* charsetpage[0..rows]: how large is a page for a row */</span>
  <span class="enscript-type">int</span> ncharsetblocks;
  Block* charsetblocks; <span class="enscript-comment">/* blocks[0..nblocks-1] */</span>
  <span class="enscript-type">int</span>* uni2charset; <span class="enscript-comment">/* uni2charset[0x0000..0xffff] */</span>
  <span class="enscript-type">int</span> fffd;    <span class="enscript-comment">/* uni representation of the invalid character */</span>
} Encoding;

<span class="enscript-comment">/*
 * Outputs the file title.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">output_title</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *charsetname)
{
  printf(<span class="enscript-string">&quot;/*\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * Copyright (C) 1999-2006 Free Software Foundation, Inc.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * This file is part of the GNU LIBICONV Library.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; *\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * The GNU LIBICONV Library is free software; you can redistribute it\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * and/or modify it under the terms of the GNU Library General Public\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * License as published by the Free Software Foundation; either version 2\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * of the License, or (at your option) any later version.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; *\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * The GNU LIBICONV Library is distributed in the hope that it will be\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * Library General Public License for more details.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; *\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * You should have received a copy of the GNU Library General Public\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * License along with the GNU LIBICONV Library; see the file COPYING.LIB.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * If not, write to the Free Software Foundation, Inc., 51 Franklin Street,\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * Fifth Floor, Boston, MA 02110-1301, USA.\n&quot;</span>);
  printf(<span class="enscript-string">&quot; */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;/*\n&quot;</span>);
  printf(<span class="enscript-string">&quot; * %s\n&quot;</span>, charsetname);
  printf(<span class="enscript-string">&quot; */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
}

<span class="enscript-comment">/*
 * Reads the charset2uni table from standard input.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">read_table</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> row, col, i, i1, i2, c, j;

  enc-&gt;charset2uni = (<span class="enscript-type">int</span>**) malloc(enc-&gt;rows*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>*));
  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    enc-&gt;charset2uni[row] = (<span class="enscript-type">int</span>*) malloc(enc-&gt;cols*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++)
      enc-&gt;charset2uni[row][col] = 0xfffd;

  c = getc(stdin);
  ungetc(c,stdin);
  <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>) {
    <span class="enscript-comment">/* Read a unicode.org style .TXT file. */</span>
    <span class="enscript-keyword">for</span> (;;) {
      c = getc(stdin);
      <span class="enscript-keyword">if</span> (c == EOF)
        <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'\n'</span> || c == <span class="enscript-string">' '</span> || c == <span class="enscript-string">'\t'</span>)
        <span class="enscript-keyword">continue</span>;
      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>) {
        <span class="enscript-keyword">do</span> { c = getc(stdin); } <span class="enscript-keyword">while</span> (!(c == EOF || c == <span class="enscript-string">'\n'</span>));
        <span class="enscript-keyword">continue</span>;
      }
      ungetc(c,stdin);
      <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot;0x%x&quot;</span>, &amp;j) != 1)
        exit(1);
      i1 = j &gt;&gt; 8;
      i2 = j &amp; 0xff;
      row = enc-&gt;byte_row(i1);
      col = enc-&gt;byte_col(i2);
      <span class="enscript-keyword">if</span> (row &lt; 0 || col &lt; 0) {
        fprintf(stderr, <span class="enscript-string">&quot;lost entry for %02x %02x\n&quot;</span>, i1, i2);
        exit(1);
      }
      <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot; 0x%x&quot;</span>, &amp;enc-&gt;charset2uni[row][col]) != 1)
        exit(1);
    }
  } <span class="enscript-keyword">else</span> {
    <span class="enscript-comment">/* Read a table of hexadecimal Unicode values. */</span>
    <span class="enscript-keyword">for</span> (i1 = 32; i1 &lt; 132; i1++)
      <span class="enscript-keyword">for</span> (i2 = 32; i2 &lt; 132; i2++) {
        i = scanf(<span class="enscript-string">&quot;%x&quot;</span>, &amp;j);
        <span class="enscript-keyword">if</span> (i == EOF)
          <span class="enscript-keyword">goto</span> <span class="enscript-reference">read_done</span>;
        <span class="enscript-keyword">if</span> (i != 1)
          exit(1);
        <span class="enscript-keyword">if</span> (j &lt; 0 || j == 0xffff)
          j = 0xfffd;
        <span class="enscript-keyword">if</span> (j != 0xfffd) {
          <span class="enscript-keyword">if</span> (enc-&gt;byte_row(i1) &lt; 0 || enc-&gt;byte_col(i2) &lt; 0) {
            fprintf(stderr, <span class="enscript-string">&quot;lost entry at %02x %02x\n&quot;</span>, i1, i2);
            exit (1);
          }
          enc-&gt;charset2uni[enc-&gt;byte_row(i1)][enc-&gt;byte_col(i2)] = j;
        }
      }
   <span class="enscript-reference">read_done</span>: ;
  }
}

<span class="enscript-comment">/*
 * Determine whether the Unicode range goes outside the BMP.
 */</span>
<span class="enscript-type">static</span> bool <span class="enscript-function-name">is_charset2uni_large</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> row, col;

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++)
      <span class="enscript-keyword">if</span> (enc-&gt;charset2uni[row][col] &gt;= 0x10000)
        <span class="enscript-keyword">return</span> true;
  <span class="enscript-keyword">return</span> false;
}

<span class="enscript-comment">/*
 * Compactify the Unicode range by use of an auxiliary table,
 * so 16 bits suffice to store each value.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">compact_large_charset2uni</span> (Encoding* enc, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> **urows, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *urowshift)
{
  <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> shift;

  <span class="enscript-keyword">for</span> (shift = 8; ; shift--) {
    <span class="enscript-type">int</span> *upages = (<span class="enscript-type">int</span> *) malloc((0x110000&gt;&gt;shift) * <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));
    <span class="enscript-type">int</span> i, row, col, nurows;

    <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x110000&gt;&gt;shift; i++)
      upages[i] = -1;

    <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
      <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++)
        upages[enc-&gt;charset2uni[row][col] &gt;&gt; shift] = 0;

    nurows = 0;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x110000&gt;&gt;shift; i++)
      <span class="enscript-keyword">if</span> (upages[i] == 0)
        nurows++;

    <span class="enscript-comment">/* We want all table entries to fit in an 'unsigned short'. */</span>
    <span class="enscript-keyword">if</span> (nurows &lt;= 1&lt;&lt;(16-shift)) {
      <span class="enscript-type">int</span>** old_charset2uni;

      *urows = (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> *) malloc(nurows * <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>));
      *urowshift = shift;

      nurows = 0;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x110000&gt;&gt;shift; i++)
        <span class="enscript-keyword">if</span> (upages[i] == 0) {
          upages[i] = nurows;
          (*urows)[nurows] = i;
          nurows++;
        }

      old_charset2uni = enc-&gt;charset2uni;
      enc-&gt;charset2uni = (<span class="enscript-type">int</span>**) malloc(enc-&gt;rows*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>*));
      <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
        enc-&gt;charset2uni[row] = (<span class="enscript-type">int</span>*) malloc(enc-&gt;cols*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));
      <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
        <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++) {
          <span class="enscript-type">int</span> u = old_charset2uni[row][col];
          enc-&gt;charset2uni[row][col] =
            (upages[u &gt;&gt; shift] &lt;&lt; shift) | (u &amp; ((1 &lt;&lt; shift) - 1));
        }
      enc-&gt;fffd =
        (upages[0xfffd &gt;&gt; shift] &lt;&lt; shift) | (0xfffd &amp; ((1 &lt;&lt; shift) - 1));

      <span class="enscript-keyword">return</span> nurows;
    }
  }
  abort();
}

<span class="enscript-comment">/*
 * Computes the charsetpage[0..rows] array.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">find_charset2uni_pages</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> row, col;

  enc-&gt;charsetpage = (<span class="enscript-type">int</span>*) malloc((enc-&gt;rows+1)*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));

  <span class="enscript-keyword">for</span> (row = 0; row &lt;= enc-&gt;rows; row++)
    enc-&gt;charsetpage[row] = 0;

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++) {
    <span class="enscript-type">int</span> used = 0;
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++)
      <span class="enscript-keyword">if</span> (enc-&gt;charset2uni[row][col] != enc-&gt;fffd)
        used = col+1;
    enc-&gt;charsetpage[row] = used;
  }
}

<span class="enscript-comment">/*
 * Fills in nblocks and blocks.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">find_charset2uni_blocks</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> n, row, lastrow;

  enc-&gt;charsetblocks = (Block*) malloc(enc-&gt;rows*<span class="enscript-keyword">sizeof</span>(Block));

  n = 0;
  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">if</span> (enc-&gt;charsetpage[row] &gt; 0 &amp;&amp; (row == 0 || enc-&gt;charsetpage[row-1] == 0)) {
      <span class="enscript-keyword">for</span> (lastrow = row; enc-&gt;charsetpage[lastrow+1] &gt; 0; lastrow++);
      enc-&gt;charsetblocks[n].start = row * enc-&gt;cols;
      enc-&gt;charsetblocks[n].end = lastrow * enc-&gt;cols + enc-&gt;charsetpage[lastrow];
      n++;
    }
  enc-&gt;ncharsetblocks = n;
}

<span class="enscript-comment">/*
 * Outputs the charset to unicode table and function.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">output_charset2uni</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name, Encoding* enc)
{
  <span class="enscript-type">int</span> nurows, row, col, lastrow, col_max, i, i1_min, i1_max;
  bool is_large;
  <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>* urows;
  <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> urowshift;
  Encoding tmpenc;

  is_large = is_charset2uni_large(enc);
  <span class="enscript-keyword">if</span> (is_large) {
    <span class="enscript-comment">/* Use a temporary copy of enc. */</span>
    tmpenc = *enc;
    enc = &amp;tmpenc;
    nurows = compact_large_charset2uni(enc,&amp;urows,&amp;urowshift);
  } <span class="enscript-keyword">else</span> {
    nurows = 0; urows = NULL; urowshift = 0; enc-&gt;fffd = 0xfffd;
  }

  find_charset2uni_pages(enc);

  find_charset2uni_blocks(enc);

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">if</span> (enc-&gt;charsetpage[row] &gt; 0) {
      <span class="enscript-keyword">if</span> (row == 0 || enc-&gt;charsetpage[row-1] == 0) {
        <span class="enscript-comment">/* Start a new block. */</span>
        <span class="enscript-keyword">for</span> (lastrow = row; enc-&gt;charsetpage[lastrow+1] &gt; 0; lastrow++);
        printf(<span class="enscript-string">&quot;static const unsigned short %s_2uni_page%02x[%d] = {\n&quot;</span>,
               name, enc-&gt;row_byte(row),
               (lastrow-row) * enc-&gt;cols + enc-&gt;charsetpage[lastrow]);
      }
      printf(<span class="enscript-string">&quot;  /&quot;</span><span class="enscript-string">&quot;* 0x%02x *&quot;</span><span class="enscript-string">&quot;/\n &quot;</span>, enc-&gt;row_byte(row));
      col_max = (enc-&gt;charsetpage[row+1] &gt; 0 ? enc-&gt;cols : enc-&gt;charsetpage[row]);
      <span class="enscript-keyword">for</span> (col = 0; col &lt; col_max; col++) {
        printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>, enc-&gt;charset2uni[row][col]);
        <span class="enscript-keyword">if</span> ((col % 8) == 7 &amp;&amp; (col+1 &lt; col_max)) printf(<span class="enscript-string">&quot;\n &quot;</span>);
      }
      printf(<span class="enscript-string">&quot;\n&quot;</span>);
      <span class="enscript-keyword">if</span> (enc-&gt;charsetpage[row+1] == 0) {
        <span class="enscript-comment">/* End a block. */</span>
        printf(<span class="enscript-string">&quot;};\n&quot;</span>);
      }
    }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  <span class="enscript-keyword">if</span> (is_large) {
    printf(<span class="enscript-string">&quot;static const ucs4_t %s_2uni_upages[%d] = {\n &quot;</span>, name, nurows);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; nurows; i++) {
      printf(<span class="enscript-string">&quot; 0x%05x,&quot;</span>, urows[i] &lt;&lt; urowshift);
      <span class="enscript-keyword">if</span> ((i % 8) == 7 &amp;&amp; (i+1 &lt; nurows)) printf(<span class="enscript-string">&quot;\n &quot;</span>);
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }

  printf(<span class="enscript-string">&quot;static int\n&quot;</span>);
  printf(<span class="enscript-string">&quot;%s_mbtowc (conv_t conv, ucs4_t *pwc, const unsigned char *s, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  unsigned char c1 = s[0];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; enc-&gt;ncharsetblocks; i++) {
    i1_min = enc-&gt;row_byte(enc-&gt;charsetblocks[i].start / enc-&gt;cols);
    i1_max = enc-&gt;row_byte((enc-&gt;charsetblocks[i].end-1) / enc-&gt;cols);
    <span class="enscript-keyword">if</span> (i &gt; 0)
      printf(<span class="enscript-string">&quot; || &quot;</span>);
    <span class="enscript-keyword">if</span> (i1_min == i1_max)
      printf(<span class="enscript-string">&quot;(c1 == 0x%02x)&quot;</span>, i1_min);
    <span class="enscript-keyword">else</span>
      printf(<span class="enscript-string">&quot;(c1 &gt;= 0x%02x &amp;&amp; c1 &lt;= 0x%02x)&quot;</span>, i1_min, i1_max);
  }
  printf(<span class="enscript-string">&quot;) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    if (n &gt;= 2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned char c2 = s[1];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      if (&quot;</span>);
  printf(enc-&gt;check_col_expr, <span class="enscript-string">&quot;c2&quot;</span>);
  printf(<span class="enscript-string">&quot;) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int i = %d * (&quot;</span>, enc-&gt;cols);
  printf(enc-&gt;byte_row_expr, <span class="enscript-string">&quot;c1&quot;</span>);
  printf(<span class="enscript-string">&quot;) + (&quot;</span>);
  printf(enc-&gt;byte_col_expr, <span class="enscript-string">&quot;c2&quot;</span>);
  printf(<span class="enscript-string">&quot;);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        %s wc = 0xfffd;\n&quot;</span>, is_large ? <span class="enscript-string">&quot;ucs4_t&quot;</span> : <span class="enscript-string">&quot;unsigned short&quot;</span>);
  <span class="enscript-keyword">if</span> (is_large) printf(<span class="enscript-string">&quot;        unsigned short swc;\n&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; enc-&gt;ncharsetblocks; i++) {
    printf(<span class="enscript-string">&quot;        &quot;</span>);
    <span class="enscript-keyword">if</span> (i &gt; 0)
      printf(<span class="enscript-string">&quot;} else &quot;</span>);
    <span class="enscript-keyword">if</span> (i &lt; enc-&gt;ncharsetblocks-1)
      printf(<span class="enscript-string">&quot;if (i &lt; %d) &quot;</span>, enc-&gt;charsetblocks[i+1].start);
    printf(<span class="enscript-string">&quot;{\n&quot;</span>);
    printf(<span class="enscript-string">&quot;          if (i &lt; %d)\n&quot;</span>, enc-&gt;charsetblocks[i].end);
    printf(<span class="enscript-string">&quot;            %s = &quot;</span>, is_large ? <span class="enscript-string">&quot;swc&quot;</span> : <span class="enscript-string">&quot;wc&quot;</span>);
    printf(<span class="enscript-string">&quot;%s_2uni_page%02x[i&quot;</span>, name, enc-&gt;row_byte(enc-&gt;charsetblocks[i].start / enc-&gt;cols));
    <span class="enscript-keyword">if</span> (enc-&gt;charsetblocks[i].start &gt; 0)
      printf(<span class="enscript-string">&quot;-%d&quot;</span>, enc-&gt;charsetblocks[i].start);
    printf(<span class="enscript-string">&quot;]&quot;</span>);
    <span class="enscript-keyword">if</span> (is_large) printf(<span class="enscript-string">&quot;,\n            wc = %s_2uni_upages[swc&gt;&gt;%d] | (swc &amp; 0x%x)&quot;</span>, name, urowshift, (1 &lt;&lt; urowshift) - 1);
    printf(<span class="enscript-string">&quot;;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        if (wc != 0xfffd) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          *pwc = %swc;\n&quot;</span>, is_large ? <span class="enscript-string">&quot;&quot;</span> : <span class="enscript-string">&quot;(ucs4_t) &quot;</span>);
  printf(<span class="enscript-string">&quot;          return 2;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_TOOFEW(0);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
}

<span class="enscript-comment">/*
 * Outputs the charset to unicode table and function.
 * (Suitable if the mapping function is well defined, i.e. has no holes, and
 * is monotonically increasing with small gaps only.)
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">output_charset2uni_noholes_monotonic</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name, Encoding* enc)
{
  <span class="enscript-type">int</span> row, col, lastrow, r, col_max, i, i1_min, i1_max;

  <span class="enscript-comment">/* Choose stepsize so that stepsize*steps_per_row &gt;= enc-&gt;cols, and
     enc-&gt;charset2uni[row][col] - enc-&gt;charset2uni[row][col/stepsize*stepsize]
     is always &lt; 0x100. */</span>
  <span class="enscript-type">int</span> steps_per_row = 2;
  <span class="enscript-type">int</span> stepsize = (enc-&gt;cols + steps_per_row-1) / steps_per_row;

  find_charset2uni_pages(enc);

  find_charset2uni_blocks(enc);

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">if</span> (enc-&gt;charsetpage[row] &gt; 0) {
      <span class="enscript-keyword">if</span> (row == 0 || enc-&gt;charsetpage[row-1] == 0) {
        <span class="enscript-comment">/* Start a new block. */</span>
        <span class="enscript-keyword">for</span> (lastrow = row; enc-&gt;charsetpage[lastrow+1] &gt; 0; lastrow++);
        printf(<span class="enscript-string">&quot;static const unsigned short %s_2uni_main_page%02x[%d] = {\n &quot;</span>,
               name, enc-&gt;row_byte(row),
               steps_per_row*(lastrow-row+1));
        <span class="enscript-keyword">for</span> (r = row; r &lt;= lastrow; r++) {
          <span class="enscript-keyword">for</span> (i = 0; i &lt; steps_per_row; i++)
            printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>, enc-&gt;charset2uni[r][i*stepsize]);
          <span class="enscript-keyword">if</span> (((r-row) % 4) == 3 &amp;&amp; (r &lt; lastrow)) printf(<span class="enscript-string">&quot;\n &quot;</span>);
        }
        printf(<span class="enscript-string">&quot;\n&quot;</span>);
        printf(<span class="enscript-string">&quot;};\n&quot;</span>);
        printf(<span class="enscript-string">&quot;static const unsigned char %s_2uni_page%02x[%d] = {\n&quot;</span>,
               name, enc-&gt;row_byte(row),
               (lastrow-row) * enc-&gt;cols + enc-&gt;charsetpage[lastrow]);
      }
      printf(<span class="enscript-string">&quot;  /&quot;</span><span class="enscript-string">&quot;* 0x%02x *&quot;</span><span class="enscript-string">&quot;/\n &quot;</span>, enc-&gt;row_byte(row));
      col_max = (enc-&gt;charsetpage[row+1] &gt; 0 ? enc-&gt;cols : enc-&gt;charsetpage[row]);
      <span class="enscript-keyword">for</span> (col = 0; col &lt; col_max; col++) {
        printf(<span class="enscript-string">&quot; 0x%02x,&quot;</span>, enc-&gt;charset2uni[row][col] - enc-&gt;charset2uni[row][col/stepsize*stepsize]);
        <span class="enscript-keyword">if</span> ((col % 8) == 7 &amp;&amp; (col+1 &lt; col_max)) printf(<span class="enscript-string">&quot;\n &quot;</span>);
      }
      printf(<span class="enscript-string">&quot;\n&quot;</span>);
      <span class="enscript-keyword">if</span> (enc-&gt;charsetpage[row+1] == 0) {
        <span class="enscript-comment">/* End a block. */</span>
        printf(<span class="enscript-string">&quot;};\n&quot;</span>);
      }
    }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static int\n&quot;</span>);
  printf(<span class="enscript-string">&quot;%s_mbtowc (conv_t conv, ucs4_t *pwc, const unsigned char *s, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  unsigned char c1 = s[0];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; enc-&gt;ncharsetblocks; i++) {
    i1_min = enc-&gt;row_byte(enc-&gt;charsetblocks[i].start / enc-&gt;cols);
    i1_max = enc-&gt;row_byte((enc-&gt;charsetblocks[i].end-1) / enc-&gt;cols);
    <span class="enscript-keyword">if</span> (i &gt; 0)
      printf(<span class="enscript-string">&quot; || &quot;</span>);
    <span class="enscript-keyword">if</span> (i1_min == i1_max)
      printf(<span class="enscript-string">&quot;(c1 == 0x%02x)&quot;</span>, i1_min);
    <span class="enscript-keyword">else</span>
      printf(<span class="enscript-string">&quot;(c1 &gt;= 0x%02x &amp;&amp; c1 &lt;= 0x%02x)&quot;</span>, i1_min, i1_max);
  }
  printf(<span class="enscript-string">&quot;) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    if (n &gt;= 2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned char c2 = s[1];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      if (&quot;</span>);
  printf(enc-&gt;check_col_expr, <span class="enscript-string">&quot;c2&quot;</span>);
  printf(<span class="enscript-string">&quot;) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int row = &quot;</span>);
  printf(enc-&gt;byte_row_expr, <span class="enscript-string">&quot;c1&quot;</span>);
  printf(<span class="enscript-string">&quot;;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int col = &quot;</span>);
  printf(enc-&gt;byte_col_expr, <span class="enscript-string">&quot;c2&quot;</span>);
  printf(<span class="enscript-string">&quot;;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int i = %d * row + col;\n&quot;</span>, enc-&gt;cols);
  printf(<span class="enscript-string">&quot;        unsigned short wc = 0xfffd;\n&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; enc-&gt;ncharsetblocks; i++) {
    printf(<span class="enscript-string">&quot;        &quot;</span>);
    <span class="enscript-keyword">if</span> (i &gt; 0)
      printf(<span class="enscript-string">&quot;} else &quot;</span>);
    <span class="enscript-keyword">if</span> (i &lt; enc-&gt;ncharsetblocks-1)
      printf(<span class="enscript-string">&quot;if (i &lt; %d) &quot;</span>, enc-&gt;charsetblocks[i+1].start);
    printf(<span class="enscript-string">&quot;{\n&quot;</span>);
    printf(<span class="enscript-string">&quot;          if (i &lt; %d)\n&quot;</span>, enc-&gt;charsetblocks[i].end);
    printf(<span class="enscript-string">&quot;            wc = %s_2uni_main_page%02x[%d*&quot;</span>, name, enc-&gt;row_byte(enc-&gt;charsetblocks[i].start / enc-&gt;cols), steps_per_row);
    <span class="enscript-keyword">if</span> (enc-&gt;charsetblocks[i].start &gt; 0)
      printf(<span class="enscript-string">&quot;(row-%d)&quot;</span>, enc-&gt;charsetblocks[i].start / enc-&gt;cols);
    <span class="enscript-keyword">else</span>
      printf(<span class="enscript-string">&quot;row&quot;</span>);
    printf(<span class="enscript-string">&quot;+&quot;</span>);
    <span class="enscript-keyword">if</span> (steps_per_row == 2)
      printf(<span class="enscript-string">&quot;(col&gt;=%d?1:0)&quot;</span>, stepsize);
    <span class="enscript-keyword">else</span>
      printf(<span class="enscript-string">&quot;col/%d&quot;</span>, stepsize);
    printf(<span class="enscript-string">&quot;] + %s_2uni_page%02x[i&quot;</span>, name, enc-&gt;row_byte(enc-&gt;charsetblocks[i].start / enc-&gt;cols));
    <span class="enscript-keyword">if</span> (enc-&gt;charsetblocks[i].start &gt; 0)
      printf(<span class="enscript-string">&quot;-%d&quot;</span>, enc-&gt;charsetblocks[i].start);
    printf(<span class="enscript-string">&quot;];\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        if (wc != 0xfffd) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          *pwc = (ucs4_t) wc;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          return 2;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_TOOFEW(0);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
}

<span class="enscript-comment">/*
 * Computes the uni2charset[0x0000..0x2ffff] array.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">invert</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> row, col, j;

  enc-&gt;uni2charset = (<span class="enscript-type">int</span>*) malloc(0x30000*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));

  <span class="enscript-keyword">for</span> (j = 0; j &lt; 0x30000; j++)
    enc-&gt;uni2charset[j] = 0;

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++) {
      j = enc-&gt;charset2uni[row][col];
      <span class="enscript-keyword">if</span> (j != 0xfffd)
        enc-&gt;uni2charset[j] = 0x100 * enc-&gt;row_byte(row) + enc-&gt;col_byte(col);
    }
}

<span class="enscript-comment">/*
 * Outputs the unicode to charset table and function, using a linear array.
 * (Suitable if the table is dense.)
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">output_uni2charset_dense</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name, Encoding* enc)
{
  <span class="enscript-comment">/* Like in 8bit_tab_to_h.c */</span>
  bool pages[0x300];
  <span class="enscript-type">int</span> line[0x6000];
  <span class="enscript-type">int</span> tableno;
  <span class="enscript-type">struct</span> { <span class="enscript-type">int</span> minline; <span class="enscript-type">int</span> maxline; <span class="enscript-type">int</span> usecount; } tables[0x6000];
  bool first;
  <span class="enscript-type">int</span> row, col, j, p, j1, j2, t;

  <span class="enscript-keyword">for</span> (p = 0; p &lt; 0x300; p++)
    pages[p] = false;
  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++) {
      j = enc-&gt;charset2uni[row][col];
      <span class="enscript-keyword">if</span> (j != 0xfffd)
        pages[j&gt;&gt;8] = true;
    }
  <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 0x6000; j1++) {
    bool all_invalid = true;
    <span class="enscript-keyword">for</span> (j2 = 0; j2 &lt; 8; j2++) {
      j = 8*j1+j2;
      <span class="enscript-keyword">if</span> (enc-&gt;uni2charset[j] != 0)
        all_invalid = false;
    }
    <span class="enscript-keyword">if</span> (all_invalid)
      line[j1] = -1;
    <span class="enscript-keyword">else</span>
      line[j1] = 0;
  }
  tableno = 0;
  <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 0x6000; j1++) {
    <span class="enscript-keyword">if</span> (line[j1] &gt;= 0) {
      <span class="enscript-keyword">if</span> (tableno &gt; 0
          &amp;&amp; ((j1 &gt; 0 &amp;&amp; line[j1-1] == tableno-1)
              || ((tables[tableno-1].maxline &gt;&gt; 5) == (j1 &gt;&gt; 5)
                  &amp;&amp; j1 - tables[tableno-1].maxline &lt;= 8))) {
        line[j1] = tableno-1;
        tables[tableno-1].maxline = j1;
      } <span class="enscript-keyword">else</span> {
        tableno++;
        line[j1] = tableno-1;
        tables[tableno-1].minline = tables[tableno-1].maxline = j1;
      }
    }
  }
  <span class="enscript-keyword">for</span> (t = 0; t &lt; tableno; t++) {
    tables[t].usecount = 0;
    j1 = 8*tables[t].minline;
    j2 = 8*(tables[t].maxline+1);
    <span class="enscript-keyword">for</span> (j = j1; j &lt; j2; j++)
      <span class="enscript-keyword">if</span> (enc-&gt;uni2charset[j] != 0)
        tables[t].usecount++;
  }
  {
    p = -1;
    <span class="enscript-keyword">for</span> (t = 0; t &lt; tableno; t++)
      <span class="enscript-keyword">if</span> (tables[t].usecount &gt; 1) {
        p = tables[t].minline &gt;&gt; 5;
        printf(<span class="enscript-string">&quot;static const unsigned short %s_page%02x[%d] = {\n&quot;</span>, name, p, 8*(tables[t].maxline-tables[t].minline+1));
        <span class="enscript-keyword">for</span> (j1 = tables[t].minline; j1 &lt;= tables[t].maxline; j1++) {
          <span class="enscript-keyword">if</span> ((j1 % 0x20) == 0 &amp;&amp; j1 &gt; tables[t].minline)
            printf(<span class="enscript-string">&quot;  /* 0x%04x */\n&quot;</span>, 8*j1);
          printf(<span class="enscript-string">&quot; &quot;</span>);
          <span class="enscript-keyword">for</span> (j2 = 0; j2 &lt; 8; j2++) {
            j = 8*j1+j2;
            printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>, enc-&gt;uni2charset[j]);
          }
          printf(<span class="enscript-string">&quot; /*0x%02x-0x%02x*/\n&quot;</span>, 8*(j1 % 0x20), 8*(j1 % 0x20)+7);
        }
        printf(<span class="enscript-string">&quot;};\n&quot;</span>);
      }
    <span class="enscript-keyword">if</span> (p &gt;= 0)
      printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;static int\n%s_wctomb (conv_t conv, unsigned char *r, ucs4_t wc, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (n &gt;= 2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    unsigned short c = 0;\n&quot;</span>);
  first = true;
  <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 0x6000;) {
    t = line[j1];
    <span class="enscript-keyword">for</span> (j2 = j1; j2 &lt; 0x6000 &amp;&amp; line[j2] == t; j2++);
    <span class="enscript-keyword">if</span> (t &gt;= 0) {
      <span class="enscript-keyword">if</span> (j1 != tables[t].minline) abort();
      <span class="enscript-keyword">if</span> (j2 &gt; tables[t].maxline+1) abort();
      j2 = tables[t].maxline+1;
      <span class="enscript-keyword">if</span> (first)
        printf(<span class="enscript-string">&quot;    &quot;</span>);
      <span class="enscript-keyword">else</span>
        printf(<span class="enscript-string">&quot;    else &quot;</span>);
      first = false;
      <span class="enscript-keyword">if</span> (tables[t].usecount == 0) abort();
      <span class="enscript-keyword">if</span> (tables[t].usecount == 1) {
        <span class="enscript-keyword">if</span> (j2 != j1+1) abort();
        <span class="enscript-keyword">for</span> (j = 8*j1; j &lt; 8*j2; j++)
          <span class="enscript-keyword">if</span> (enc-&gt;uni2charset[j] != 0) {
            printf(<span class="enscript-string">&quot;if (wc == 0x%04x)\n      c = 0x%02x;\n&quot;</span>, j, enc-&gt;uni2charset[j]);
            <span class="enscript-keyword">break</span>;
          }
      } <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">if</span> (j1 == 0) {
          printf(<span class="enscript-string">&quot;if (wc &lt; 0x%04x)&quot;</span>, 8*j2);
        } <span class="enscript-keyword">else</span> {
          printf(<span class="enscript-string">&quot;if (wc &gt;= 0x%04x &amp;&amp; wc &lt; 0x%04x)&quot;</span>, 8*j1, 8*j2);
        }
        printf(<span class="enscript-string">&quot;\n      c = %s_page%02x[wc&quot;</span>, name, j1 &gt;&gt; 5);
        <span class="enscript-keyword">if</span> (tables[t].minline &gt; 0)
          printf(<span class="enscript-string">&quot;-0x%04x&quot;</span>, 8*j1);
        printf(<span class="enscript-string">&quot;];\n&quot;</span>);
      }
    }
    j1 = j2;
  }
  printf(<span class="enscript-string">&quot;    if (c != 0) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      r[0] = (c &gt;&gt; 8); r[1] = (c &amp; 0xff);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      return 2;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_ILUNI;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_TOOSMALL;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
}

<span class="enscript-comment">/*
 * Outputs the unicode to charset table and function, using a packed array.
 * (Suitable if the table is sparse.)
 * The argument 'monotonic' may be set to true if the mapping is monotonically
 * increasing with small gaps only.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">output_uni2charset_sparse</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name, Encoding* enc, bool monotonic)
{
  bool pages[0x300];
  Block pageblocks[0x300]; <span class="enscript-type">int</span> npageblocks;
  <span class="enscript-type">int</span> indx2charset[0x30000];
  <span class="enscript-type">int</span> summary_indx[0x3000];
  <span class="enscript-type">int</span> summary_used[0x3000];
  <span class="enscript-type">int</span> i, row, col, j, p, j1, j2, indx;
  bool is_large;
  <span class="enscript-comment">/* for monotonic: */</span>
  <span class="enscript-type">int</span> log2_stepsize = (!strcmp(name,<span class="enscript-string">&quot;uhc_2&quot;</span>) ? 6 : 7);
  <span class="enscript-type">int</span> stepsize = 1 &lt;&lt; log2_stepsize;
  <span class="enscript-type">int</span> indxsteps;

  <span class="enscript-comment">/* Fill pages[0x300]. */</span>
  <span class="enscript-keyword">for</span> (p = 0; p &lt; 0x300; p++)
    pages[p] = false;
  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++) {
      j = enc-&gt;charset2uni[row][col];
      <span class="enscript-keyword">if</span> (j != 0xfffd)
        pages[j&gt;&gt;8] = true;
    }

  <span class="enscript-comment">/* Determine whether two or three bytes are needed for each character. */</span>
  is_large = false;
  <span class="enscript-keyword">for</span> (j = 0; j &lt; 0x30000; j++)
    <span class="enscript-keyword">if</span> (enc-&gt;uni2charset[j] &gt;= 0x10000)
      is_large = true;

#<span class="enscript-reference">if</span> 0
  <span class="enscript-keyword">for</span> (p = 0; p &lt; 0x300; p++)
    <span class="enscript-keyword">if</span> (pages[p]) {
      printf(<span class="enscript-string">&quot;static const unsigned short %s_page%02x[256] = {\n&quot;</span>, name, p);
      <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 32; j1++) {
        printf(<span class="enscript-string">&quot;  &quot;</span>);
        <span class="enscript-keyword">for</span> (j2 = 0; j2 &lt; 8; j2++)
          printf(<span class="enscript-string">&quot;0x%04x, &quot;</span>, enc-&gt;uni2charset[256*p+8*j1+j2]);
        printf(<span class="enscript-string">&quot;/&quot;</span><span class="enscript-string">&quot;*0x%02x-0x%02x*&quot;</span><span class="enscript-string">&quot;/\n&quot;</span>, 8*j1, 8*j1+7);
      }
      printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
#<span class="enscript-reference">endif</span>

  <span class="enscript-comment">/* Fill summary_indx[] and summary_used[]. */</span>
  indx = 0;
  <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 0x3000; j1++) {
    summary_indx[j1] = indx;
    summary_used[j1] = 0;
    <span class="enscript-keyword">for</span> (j2 = 0; j2 &lt; 16; j2++) {
      j = 16*j1+j2;
      <span class="enscript-keyword">if</span> (enc-&gt;uni2charset[j] != 0) {
        indx2charset[indx++] = enc-&gt;uni2charset[j];
        summary_used[j1] |= (1 &lt;&lt; j2);
      }
    }
  }

  <span class="enscript-comment">/* Fill npageblocks and pageblocks[]. */</span>
  npageblocks = 0;
  <span class="enscript-keyword">for</span> (p = 0; p &lt; 0x300; ) {
    <span class="enscript-keyword">if</span> (pages[p] &amp;&amp; (p == 0 || !pages[p-1])) {
      pageblocks[npageblocks].start = 16*p;
      <span class="enscript-keyword">do</span> p++; <span class="enscript-keyword">while</span> (p &lt; 0x300 &amp;&amp; pages[p]);
      j1 = 16*p;
      <span class="enscript-keyword">while</span> (summary_used[j1-1] == 0) j1--;
      pageblocks[npageblocks].end = j1;
      npageblocks++;
    } <span class="enscript-keyword">else</span>
      p++;
  }

  <span class="enscript-keyword">if</span> (monotonic) {
    indxsteps = (indx + stepsize-1) / stepsize;
    printf(<span class="enscript-string">&quot;static const unsigned short %s_2charset_main[%d] = {\n&quot;</span>, name, indxsteps);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; indxsteps; ) {
      <span class="enscript-keyword">if</span> ((i % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
      printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>, indx2charset[i*stepsize]);
      i++;
      <span class="enscript-keyword">if</span> ((i % 8) == 0 || i == indxsteps) printf(<span class="enscript-string">&quot;\n&quot;</span>);
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    printf(<span class="enscript-string">&quot;static const unsigned char %s_2charset[%d] = {\n&quot;</span>, name, indx);
    <span class="enscript-keyword">for</span> (i = 0; i &lt; indx; ) {
      <span class="enscript-keyword">if</span> ((i % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
      printf(<span class="enscript-string">&quot; 0x%02x,&quot;</span>, indx2charset[i] - indx2charset[i/stepsize*stepsize]);
      i++;
      <span class="enscript-keyword">if</span> ((i % 8) == 0 || i == indx) printf(<span class="enscript-string">&quot;\n&quot;</span>);
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
  } <span class="enscript-keyword">else</span> {
    <span class="enscript-keyword">if</span> (is_large) {
      printf(<span class="enscript-string">&quot;static const unsigned char %s_2charset[3*%d] = {\n&quot;</span>, name, indx);
      <span class="enscript-keyword">for</span> (i = 0; i &lt; indx; ) {
        <span class="enscript-keyword">if</span> ((i % 4) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
        printf(<span class="enscript-string">&quot; 0x%1x,0x%02x,0x%02x,&quot;</span>, indx2charset[i] &gt;&gt; 16,
               (indx2charset[i] &gt;&gt; 8) &amp; 0xff, indx2charset[i] &amp; 0xff);
        i++;
        <span class="enscript-keyword">if</span> ((i % 4) == 0 || i == indx) printf(<span class="enscript-string">&quot;\n&quot;</span>);
      }
      printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
      printf(<span class="enscript-string">&quot;static const unsigned short %s_2charset[%d] = {\n&quot;</span>, name, indx);
      <span class="enscript-keyword">for</span> (i = 0; i &lt; indx; ) {
        <span class="enscript-keyword">if</span> ((i % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
        printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>, indx2charset[i]);
        i++;
        <span class="enscript-keyword">if</span> ((i % 8) == 0 || i == indx) printf(<span class="enscript-string">&quot;\n&quot;</span>);
      }
      printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    }
  }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; npageblocks; i++) {
    printf(<span class="enscript-string">&quot;static const Summary16 %s_uni2indx_page%02x[%d] = {\n&quot;</span>, name,
           pageblocks[i].start/16, pageblocks[i].end-pageblocks[i].start);
    <span class="enscript-keyword">for</span> (j1 = pageblocks[i].start; j1 &lt; pageblocks[i].end; ) {
      <span class="enscript-keyword">if</span> (((16*j1) % 0x100) == 0) printf(<span class="enscript-string">&quot;  /&quot;</span><span class="enscript-string">&quot;* 0x%04x *&quot;</span><span class="enscript-string">&quot;/\n&quot;</span>, 16*j1);
      <span class="enscript-keyword">if</span> ((j1 % 4) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
      printf(<span class="enscript-string">&quot; { %4d, 0x%04x },&quot;</span>, summary_indx[j1], summary_used[j1]);
      j1++;
      <span class="enscript-keyword">if</span> ((j1 % 4) == 0 || j1 == pageblocks[i].end) printf(<span class="enscript-string">&quot;\n&quot;</span>);
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static int\n&quot;</span>);
  printf(<span class="enscript-string">&quot;%s_wctomb (conv_t conv, unsigned char *r, ucs4_t wc, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (n &gt;= 2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    const Summary16 *summary = NULL;\n&quot;</span>);
  <span class="enscript-keyword">for</span> (i = 0; i &lt; npageblocks; i++) {
    printf(<span class="enscript-string">&quot;    &quot;</span>);
    <span class="enscript-keyword">if</span> (i &gt; 0)
      printf(<span class="enscript-string">&quot;else &quot;</span>);
    printf(<span class="enscript-string">&quot;if (wc &gt;= 0x%04x &amp;&amp; wc &lt; 0x%04x)\n&quot;</span>,
           16*pageblocks[i].start, 16*pageblocks[i].end);
    printf(<span class="enscript-string">&quot;      summary = &amp;%s_uni2indx_page%02x[(wc&gt;&gt;4)&quot;</span>, name,
           pageblocks[i].start/16);
    <span class="enscript-keyword">if</span> (pageblocks[i].start &gt; 0)
      printf(<span class="enscript-string">&quot;-0x%03x&quot;</span>, pageblocks[i].start);
    printf(<span class="enscript-string">&quot;];\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;    if (summary) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned short used = summary-&gt;used;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned int i = wc &amp; 0x0f;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      if (used &amp; ((unsigned short) 1 &lt;&lt; i)) {\n&quot;</span>);
  <span class="enscript-keyword">if</span> (monotonic || !is_large)
    printf(<span class="enscript-string">&quot;        unsigned short c;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        /* Keep in `used' only the bits 0..i-1. */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used &amp;= ((unsigned short) 1 &lt;&lt; i) - 1;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        /* Add `summary-&gt;indx' and the number of bits set in `used'. */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x5555) + ((used &amp; 0xaaaa) &gt;&gt; 1);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x3333) + ((used &amp; 0xcccc) &gt;&gt; 2);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x0f0f) + ((used &amp; 0xf0f0) &gt;&gt; 4);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x00ff) + (used &gt;&gt; 8);\n&quot;</span>);
  <span class="enscript-keyword">if</span> (monotonic) {
    printf(<span class="enscript-string">&quot;        used += summary-&gt;indx;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;        c = %s_2charset_main[used&gt;&gt;%d] + %s_2charset[used];\n&quot;</span>, name, log2_stepsize, name);
    printf(<span class="enscript-string">&quot;        r[0] = (c &gt;&gt; 8); r[1] = (c &amp; 0xff);\n&quot;</span>);
    printf(<span class="enscript-string">&quot;        return 2;\n&quot;</span>);
  } <span class="enscript-keyword">else</span> {
    <span class="enscript-keyword">if</span> (is_large) {
      printf(<span class="enscript-string">&quot;        used += summary-&gt;indx;\n&quot;</span>);
      printf(<span class="enscript-string">&quot;        r[0] = %s_2charset[3*used];\n&quot;</span>, name);
      printf(<span class="enscript-string">&quot;        r[1] = %s_2charset[3*used+1];\n&quot;</span>, name);
      printf(<span class="enscript-string">&quot;        r[2] = %s_2charset[3*used+2];\n&quot;</span>, name);
      printf(<span class="enscript-string">&quot;        return 3;\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
      printf(<span class="enscript-string">&quot;        c = %s_2charset[summary-&gt;indx + used];\n&quot;</span>, name);
      printf(<span class="enscript-string">&quot;        r[0] = (c &gt;&gt; 8); r[1] = (c &amp; 0xff);\n&quot;</span>);
      printf(<span class="enscript-string">&quot;        return 2;\n&quot;</span>);
    }
  }
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_ILUNI;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_TOOSMALL;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
}

<span class="enscript-comment">/* ISO-2022/EUC specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_normal</span> (<span class="enscript-type">int</span> row) { <span class="enscript-keyword">return</span> 0x21+row; }
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_normal</span> (<span class="enscript-type">int</span> col) { <span class="enscript-keyword">return</span> 0x21+col; }
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_normal</span> (<span class="enscript-type">int</span> byte) { <span class="enscript-keyword">return</span> byte-0x21; }
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_normal</span> (<span class="enscript-type">int</span> byte) { <span class="enscript-keyword">return</span> byte-0x21; }

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_normal</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 94;
  enc.row_byte = row_byte_normal;
  enc.col_byte = col_byte_normal;
  enc.byte_row = byte_row_normal;
  enc.byte_col = byte_col_normal;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* Note: On first sight, the jisx0212_2charset[] table seems to be in order,
   starting from the charset=0x3021/uni=0x4e02 pair. But it's only mostly in
   order. There are 75 out-of-order values, scattered all throughout the table.
 */</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_normal_only_charset2uni</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 94;
  enc.row_byte = row_byte_normal;
  enc.col_byte = col_byte_normal;
  enc.byte_row = byte_row_normal;
  enc.byte_col = byte_col_normal;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
}

<span class="enscript-comment">/* CNS 11643 specifics - trick to put two tables into one */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_cns11643</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x100 * (row / 94) + (row % 94) + 0x21;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_cns11643</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">return</span> (byte &gt;&gt; 8) * 94 + (byte &amp; 0xff) - 0x21;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_cns11643_only_uni2charset</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 16*94;
  enc.cols = 94;
  enc.row_byte = row_byte_cns11643;
  enc.col_byte = col_byte_normal;
  enc.byte_row = byte_row_cns11643;
  enc.byte_col = byte_col_normal;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;

  read_table(&amp;enc);
  invert(&amp;enc);
  output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* GBK specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_gbk1</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x81+row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_gbk1</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x3f ? 0x41 : 0x40) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_gbk1</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x81;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_gbk1</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x40 &amp;&amp; byte &lt; 0x7f)
    <span class="enscript-keyword">return</span> byte-0x40;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x80 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_gbk1</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 126;
  enc.cols = 190;
  enc.row_byte = row_byte_gbk1;
  enc.col_byte = col_byte_gbk1;
  enc.byte_row = byte_row_gbk1;
  enc.byte_col = byte_col_gbk1;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x81&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x80 ? 0x41 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_dense(name,&amp;enc);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_gbk1_only_charset2uni</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 126;
  enc.cols = 190;
  enc.row_byte = row_byte_gbk1;
  enc.col_byte = col_byte_gbk1;
  enc.byte_row = byte_row_gbk1;
  enc.byte_col = byte_col_gbk1;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x81&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x80 ? 0x41 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_gbk2</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x81+row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_gbk2</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x3f ? 0x41 : 0x40) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_gbk2</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x81;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_gbk2</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x40 &amp;&amp; byte &lt; 0x7f)
    <span class="enscript-keyword">return</span> byte-0x40;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x80 &amp;&amp; byte &lt; 0xa1)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_gbk2_only_charset2uni</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 126;
  enc.cols = 96;
  enc.row_byte = row_byte_gbk2;
  enc.col_byte = col_byte_gbk2;
  enc.byte_row = byte_row_gbk2;
  enc.byte_col = byte_col_gbk2;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xa1)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x81&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x80 ? 0x41 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_gbk1_only_uni2charset</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 126;
  enc.cols = 190;
  enc.row_byte = row_byte_gbk1;
  enc.col_byte = col_byte_gbk1;
  enc.byte_row = byte_row_gbk1;
  enc.byte_col = byte_col_gbk1;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x81&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x80 ? 0x41 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* KSC 5601 specifics */</span>

<span class="enscript-comment">/*
 * Reads the charset2uni table from standard input.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">read_table_ksc5601</span> (Encoding* enc)
{
  <span class="enscript-type">int</span> row, col, i, i1, i2, c, j;

  enc-&gt;charset2uni = (<span class="enscript-type">int</span>**) malloc(enc-&gt;rows*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>*));
  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    enc-&gt;charset2uni[row] = (<span class="enscript-type">int</span>*) malloc(enc-&gt;cols*<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">int</span>));

  <span class="enscript-keyword">for</span> (row = 0; row &lt; enc-&gt;rows; row++)
    <span class="enscript-keyword">for</span> (col = 0; col &lt; enc-&gt;cols; col++)
      enc-&gt;charset2uni[row][col] = 0xfffd;

  c = getc(stdin);
  ungetc(c,stdin);
  <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>) {
    <span class="enscript-comment">/* Read a unicode.org style .TXT file. */</span>
    <span class="enscript-keyword">for</span> (;;) {
      c = getc(stdin);
      <span class="enscript-keyword">if</span> (c == EOF)
        <span class="enscript-keyword">break</span>;
      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'\n'</span> || c == <span class="enscript-string">' '</span> || c == <span class="enscript-string">'\t'</span>)
        <span class="enscript-keyword">continue</span>;
      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>) {
        <span class="enscript-keyword">do</span> { c = getc(stdin); } <span class="enscript-keyword">while</span> (!(c == EOF || c == <span class="enscript-string">'\n'</span>));
        <span class="enscript-keyword">continue</span>;
      }
      ungetc(c,stdin);
      <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot;0x%x&quot;</span>, &amp;j) != 1)
        exit(1);
      i1 = j &gt;&gt; 8;
      i2 = j &amp; 0xff;
      <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot; 0x%x&quot;</span>, &amp;j) != 1)
        exit(1);
      <span class="enscript-comment">/* Take only the range covered by KS C 5601.1987-0 = KS C 5601.1989-0
         = KS X 1001.1992, ignore the rest. */</span>
      <span class="enscript-keyword">if</span> (!(i1 &gt;= 128+33 &amp;&amp; i1 &lt; 128+127 &amp;&amp; i2 &gt;= 128+33 &amp;&amp; i2 &lt; 128+127))
        <span class="enscript-keyword">continue</span>;  <span class="enscript-comment">/* KSC5601 specific */</span>
      i1 &amp;= 0x7f;  <span class="enscript-comment">/* KSC5601 specific */</span>
      i2 &amp;= 0x7f;  <span class="enscript-comment">/* KSC5601 specific */</span>
      row = enc-&gt;byte_row(i1);
      col = enc-&gt;byte_col(i2);
      <span class="enscript-keyword">if</span> (row &lt; 0 || col &lt; 0) {
        fprintf(stderr, <span class="enscript-string">&quot;lost entry for %02x %02x\n&quot;</span>, i1, i2);
        exit(1);
      }
      enc-&gt;charset2uni[row][col] = j;
    }
  } <span class="enscript-keyword">else</span> {
    <span class="enscript-comment">/* Read a table of hexadecimal Unicode values. */</span>
    <span class="enscript-keyword">for</span> (i1 = 33; i1 &lt; 127; i1++)
      <span class="enscript-keyword">for</span> (i2 = 33; i2 &lt; 127; i2++) {
        i = scanf(<span class="enscript-string">&quot;%x&quot;</span>, &amp;j);
        <span class="enscript-keyword">if</span> (i == EOF)
          <span class="enscript-keyword">goto</span> <span class="enscript-reference">read_done</span>;
        <span class="enscript-keyword">if</span> (i != 1)
          exit(1);
        <span class="enscript-keyword">if</span> (j &lt; 0 || j == 0xffff)
          j = 0xfffd;
        <span class="enscript-keyword">if</span> (j != 0xfffd) {
          <span class="enscript-keyword">if</span> (enc-&gt;byte_row(i1) &lt; 0 || enc-&gt;byte_col(i2) &lt; 0) {
            fprintf(stderr, <span class="enscript-string">&quot;lost entry at %02x %02x\n&quot;</span>, i1, i2);
            exit (1);
          }
          enc-&gt;charset2uni[enc-&gt;byte_row(i1)][enc-&gt;byte_col(i2)] = j;
        }
      }
   <span class="enscript-reference">read_done</span>: ;
  }
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_ksc5601</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 94;
  enc.row_byte = row_byte_normal;
  enc.col_byte = col_byte_normal;
  enc.byte_row = byte_row_normal;
  enc.byte_col = byte_col_normal;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x21 &amp;&amp; %1$s &lt; 0x7f&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - 0x21&quot;</span>;

  read_table_ksc5601(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* UHC specifics */</span>

<span class="enscript-comment">/* UHC part 1: 0x{81..A0}{41..5A,61..7A,81..FE} */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_uhc_1</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x81 + row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_uhc_1</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x34 ? 0x4d : col &gt;= 0x1a ? 0x47 : 0x41) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_uhc_1</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xa1)
    <span class="enscript-keyword">return</span> byte-0x81;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_uhc_1</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x41 &amp;&amp; byte &lt; 0x5b)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x61 &amp;&amp; byte &lt; 0x7b)
    <span class="enscript-keyword">return</span> byte-0x47;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x4d;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_uhc_1</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 32;
  enc.cols = 178;
  enc.row_byte = row_byte_uhc_1;
  enc.col_byte = col_byte_uhc_1;
  enc.byte_row = byte_row_uhc_1;
  enc.byte_col = byte_col_uhc_1;
  enc.check_row_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xa1)&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x41 &amp;&amp; %1$s &lt; 0x5b) || (%1$s &gt;= 0x61 &amp;&amp; %1$s &lt; 0x7b) || (%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x81&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x81 ? 0x4d : %1$s &gt;= 0x61 ? 0x47 : 0x41)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni_noholes_monotonic(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,true);
}

<span class="enscript-comment">/* UHC part 2: 0x{A1..C6}{41..5A,61..7A,81..A0} */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_uhc_2</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0xa1 + row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_uhc_2</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x34 ? 0x4d : col &gt;= 0x1a ? 0x47 : 0x41) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_uhc_2</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0xa1 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0xa1;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_uhc_2</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x41 &amp;&amp; byte &lt; 0x5b)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x61 &amp;&amp; byte &lt; 0x7b)
    <span class="enscript-keyword">return</span> byte-0x47;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xa1)
    <span class="enscript-keyword">return</span> byte-0x4d;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_uhc_2</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 84;
  enc.row_byte = row_byte_uhc_2;
  enc.col_byte = col_byte_uhc_2;
  enc.byte_row = byte_row_uhc_2;
  enc.byte_col = byte_col_uhc_2;
  enc.check_row_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0xa1 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x41 &amp;&amp; %1$s &lt; 0x5b) || (%1$s &gt;= 0x61 &amp;&amp; %1$s &lt; 0x7b) || (%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xa1)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0xa1&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x81 ? 0x4d : %1$s &gt;= 0x61 ? 0x47 : 0x41)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni_noholes_monotonic(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,true);
}

<span class="enscript-comment">/* Big5 specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_big5</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0xa1+row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_big5</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x3f ? 0x62 : 0x40) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_big5</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0xa1 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0xa1;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_big5</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x40 &amp;&amp; byte &lt; 0x7f)
    <span class="enscript-keyword">return</span> byte-0x40;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0xa1 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x62;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_big5</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 157;
  enc.row_byte = row_byte_big5;
  enc.col_byte = col_byte_big5;
  enc.byte_row = byte_row_big5;
  enc.byte_col = byte_col_big5;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0xa1 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0xa1 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0xa1&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0xa1 ? 0x62 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* HKSCS specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_hkscs</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x80+row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_hkscs</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x80 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x80;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_hkscs</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 128;
  enc.cols = 157;
  enc.row_byte = row_byte_hkscs;
  enc.col_byte = col_byte_big5;
  enc.byte_row = byte_row_hkscs;
  enc.byte_col = byte_col_big5;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xff&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0xa1 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x80&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0xa1 ? 0x62 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* Johab Hangul specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_johab_hangul</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> 0x84+row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_johab_hangul</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x3e ? 0x43 : 0x41) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_johab_hangul</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x84 &amp;&amp; byte &lt; 0xd4)
    <span class="enscript-keyword">return</span> byte-0x84;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_johab_hangul</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x41 &amp;&amp; byte &lt; 0x7f)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xff)
    <span class="enscript-keyword">return</span> byte-0x43;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_johab_hangul</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 80;
  enc.cols = 188;
  enc.row_byte = row_byte_johab_hangul;
  enc.col_byte = col_byte_johab_hangul;
  enc.byte_row = byte_row_johab_hangul;
  enc.byte_col = byte_col_johab_hangul;
  enc.check_row_expr = <span class="enscript-string">&quot;%1$s &gt;= 0x84 &amp;&amp; %1$s &lt; 0xd4&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x41 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xff)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - 0x84&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x81 ? 0x43 : 0x41)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_dense(name,&amp;enc);
}

<span class="enscript-comment">/* SJIS specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">row_byte_sjis</span> (<span class="enscript-type">int</span> row) {
  <span class="enscript-keyword">return</span> (row &gt;= 0x1f ? 0xc1 : 0x81) + row;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">col_byte_sjis</span> (<span class="enscript-type">int</span> col) {
  <span class="enscript-keyword">return</span> (col &gt;= 0x3f ? 0x41 : 0x40) + col;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_row_sjis</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x81 &amp;&amp; byte &lt; 0xa0)
    <span class="enscript-keyword">return</span> byte-0x81;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0xe0)
    <span class="enscript-keyword">return</span> byte-0xc1;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">byte_col_sjis</span> (<span class="enscript-type">int</span> byte) {
  <span class="enscript-keyword">if</span> (byte &gt;= 0x40 &amp;&amp; byte &lt; 0x7f)
    <span class="enscript-keyword">return</span> byte-0x40;
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (byte &gt;= 0x80 &amp;&amp; byte &lt; 0xfd)
    <span class="enscript-keyword">return</span> byte-0x41;
  <span class="enscript-keyword">else</span>
    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_sjis</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  Encoding enc;

  enc.rows = 94;
  enc.cols = 188;
  enc.row_byte = row_byte_sjis;
  enc.col_byte = col_byte_sjis;
  enc.byte_row = byte_row_sjis;
  enc.byte_col = byte_col_sjis;
  enc.check_row_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x81 &amp;&amp; %1$s &lt; 0xa0) || (%1$s &gt;= 0xe0)&quot;</span>;
  enc.check_col_expr = <span class="enscript-string">&quot;(%1$s &gt;= 0x40 &amp;&amp; %1$s &lt; 0x7f) || (%1$s &gt;= 0x80 &amp;&amp; %1$s &lt; 0xfd)&quot;</span>;
  enc.byte_row_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0xe0 ? 0xc1 : 0x81)&quot;</span>;
  enc.byte_col_expr = <span class="enscript-string">&quot;%1$s - (%1$s &gt;= 0x80 ? 0x41 : 0x40)&quot;</span>;

  read_table(&amp;enc);
  output_charset2uni(name,&amp;enc);
  invert(&amp;enc); output_uni2charset_sparse(name,&amp;enc,false);
}

<span class="enscript-comment">/* GB18030 Unicode specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_gb18030uni</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  <span class="enscript-type">int</span> c;
  <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> bytes;
  <span class="enscript-type">int</span> i1, i2, i3, i4, i, j, k;
  <span class="enscript-type">int</span> charset2uni[4*10*126*10];
  <span class="enscript-type">int</span> uni2charset[0x10000];
  <span class="enscript-type">struct</span> { <span class="enscript-type">int</span> low; <span class="enscript-type">int</span> high; <span class="enscript-type">int</span> diff; <span class="enscript-type">int</span> total; } ranges[256];
  <span class="enscript-type">int</span> ranges_count, ranges_total;

  <span class="enscript-keyword">for</span> (i = 0; i &lt; 4*10*126*10; i++)
    charset2uni[i] = 0;
  <span class="enscript-keyword">for</span> (j = 0; j &lt; 0x10000; j++)
    uni2charset[j] = 0;

  <span class="enscript-comment">/* Read a unicode.org style .TXT file. */</span>
  <span class="enscript-keyword">for</span> (;;) {
    c = getc(stdin);
    <span class="enscript-keyword">if</span> (c == EOF)
      <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'\n'</span> || c == <span class="enscript-string">' '</span> || c == <span class="enscript-string">'\t'</span>)
      <span class="enscript-keyword">continue</span>;
    <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>) {
      <span class="enscript-keyword">do</span> { c = getc(stdin); } <span class="enscript-keyword">while</span> (!(c == EOF || c == <span class="enscript-string">'\n'</span>));
      <span class="enscript-keyword">continue</span>;
    }
    ungetc(c,stdin);
    <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot;0x%x&quot;</span>, &amp;bytes) != 1)
      exit(1);
    i1 = (bytes &gt;&gt; 24) &amp; 0xff;
    i2 = (bytes &gt;&gt; 16) &amp; 0xff;
    i3 = (bytes &gt;&gt; 8) &amp; 0xff;
    i4 = bytes &amp; 0xff;
    <span class="enscript-keyword">if</span> (!(i1 &gt;= 0x81 &amp;&amp; i1 &lt;= 0x84
          &amp;&amp; i2 &gt;= 0x30 &amp;&amp; i2 &lt;= 0x39
          &amp;&amp; i3 &gt;= 0x81 &amp;&amp; i3 &lt;= 0xfe
          &amp;&amp; i4 &gt;= 0x30 &amp;&amp; i4 &lt;= 0x39)) {
      fprintf(stderr, <span class="enscript-string">&quot;lost entry for %02x %02x %02x %02x\n&quot;</span>, i1, i2, i3, i4);
      exit(1);
    }
    i = (((i1-0x81) * 10 + (i2-0x30)) * 126 + (i3-0x81)) * 10 + (i4-0x30);
    <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot; 0x%x&quot;</span>, &amp;j) != 1)
      exit(1);
    <span class="enscript-keyword">if</span> (!(j &gt;= 0 &amp;&amp; j &lt; 0x10000))
      exit(1);
    charset2uni[i] = j;
    uni2charset[j] = i;
  }

  <span class="enscript-comment">/* Verify that the mapping i -&gt; j is monotonically increasing and
     of the form
        low[k] &lt;= i &lt;= high[k]  =&gt;  j = diff[k] + i
     with a set of disjoint intervals (low[k], high[k]). */</span>
  ranges_count = 0;
  <span class="enscript-keyword">for</span> (i = 0; i &lt; 4*10*126*10; i++)
    <span class="enscript-keyword">if</span> (charset2uni[i] != 0) {
      <span class="enscript-type">int</span> diff;
      j = charset2uni[i];
      diff = j - i;
      <span class="enscript-keyword">if</span> (ranges_count &gt; 0) {
        <span class="enscript-keyword">if</span> (!(i &gt; ranges[ranges_count-1].high))
          exit(1);
        <span class="enscript-keyword">if</span> (!(j &gt; ranges[ranges_count-1].high + ranges[ranges_count-1].diff))
          exit(1);
        <span class="enscript-comment">/* Additional property: The diffs are also increasing. */</span>
        <span class="enscript-keyword">if</span> (!(diff &gt;= ranges[ranges_count-1].diff))
          exit(1);
      }
      <span class="enscript-keyword">if</span> (ranges_count &gt; 0 &amp;&amp; diff == ranges[ranges_count-1].diff)
        ranges[ranges_count-1].high = i;
      <span class="enscript-keyword">else</span> {
        <span class="enscript-keyword">if</span> (ranges_count == 256)
          exit(1);
        ranges[ranges_count].low = i;
        ranges[ranges_count].high = i;
        ranges[ranges_count].diff = diff;
        ranges_count++;
      }
    }

  <span class="enscript-comment">/* Determine size of bitmap. */</span>
  ranges_total = 0;
  <span class="enscript-keyword">for</span> (k = 0; k &lt; ranges_count; k++) {
    ranges[k].total = ranges_total;
    ranges_total += ranges[k].high - ranges[k].low + 1;
  }

  printf(<span class="enscript-string">&quot;static const unsigned short %s_charset2uni_ranges[%d] = {\n&quot;</span>, name, 2*ranges_count);
  <span class="enscript-keyword">for</span> (k = 0; k &lt; ranges_count; k++) {
    printf(<span class="enscript-string">&quot;  0x%04x, 0x%04x&quot;</span>, ranges[k].low, ranges[k].high);
    <span class="enscript-keyword">if</span> (k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;,&quot;</span>);
    <span class="enscript-keyword">if</span> ((k % 4) == 3 &amp;&amp; k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;};\n&quot;</span>);

  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static const unsigned short %s_uni2charset_ranges[%d] = {\n&quot;</span>, name, 2*ranges_count);
  <span class="enscript-keyword">for</span> (k = 0; k &lt; ranges_count; k++) {
    printf(<span class="enscript-string">&quot;  0x%04x, 0x%04x&quot;</span>, ranges[k].low + ranges[k].diff, ranges[k].high + ranges[k].diff);
    <span class="enscript-keyword">if</span> (k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;,&quot;</span>);
    <span class="enscript-keyword">if</span> ((k % 4) == 3 &amp;&amp; k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;};\n&quot;</span>);

  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static const struct { unsigned short diff; unsigned short bitmap_offset; } %s_ranges[%d] = {\n &quot;</span>, name, ranges_count);
  <span class="enscript-keyword">for</span> (k = 0; k &lt; ranges_count; k++) {
    printf(<span class="enscript-string">&quot; { %5d, 0x%04x }&quot;</span>, ranges[k].diff, ranges[k].total);
    <span class="enscript-keyword">if</span> (k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;,&quot;</span>);
    <span class="enscript-keyword">if</span> ((k % 4) == 3 &amp;&amp; k+1 &lt; ranges_count) printf(<span class="enscript-string">&quot;\n &quot;</span>);
  }
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;};\n&quot;</span>);

  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static const unsigned char %s_bitmap[%d] = {\n &quot;</span>, name, (ranges_total + 7) / 8);
  {
    <span class="enscript-type">int</span> accu = 0;
    <span class="enscript-keyword">for</span> (k = 0; k &lt; ranges_count; k++) {
      <span class="enscript-keyword">for</span> (i = ranges[k].total; i &lt;= ranges[k].total + (ranges[k].high - ranges[k].low);) {
        <span class="enscript-keyword">if</span> (charset2uni[i - ranges[k].total + ranges[k].low] != 0)
          accu |= (1 &lt;&lt; (i % 8));
        i++;
        <span class="enscript-keyword">if</span> ((i % 8) == 0) {
          printf(<span class="enscript-string">&quot; 0x%02x&quot;</span>, accu);
          <span class="enscript-keyword">if</span> ((i / 8) &lt; (ranges_total + 7) / 8) printf(<span class="enscript-string">&quot;,&quot;</span>);
          <span class="enscript-keyword">if</span> (((i / 8) % 12) == 0)
            printf(<span class="enscript-string">&quot;\n &quot;</span>);
          accu = 0;
        }
      }
      <span class="enscript-keyword">if</span> (i != (k+1 &lt; ranges_count ? ranges[k+1].total : ranges_total)) abort();
    }
    <span class="enscript-keyword">if</span> ((ranges_total % 8) != 0)
      printf(<span class="enscript-string">&quot; 0x%02x&quot;</span>, accu);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;};\n&quot;</span>);

  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static int\n&quot;</span>);
  printf(<span class="enscript-string">&quot;%s_mbtowc (conv_t conv, ucs4_t *pwc, const unsigned char *s, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  unsigned char c1 = s[0];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (c1 &gt;= 0x81 &amp;&amp; c1 &lt;= 0x84) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    if (n &gt;= 2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned char c2 = s[1];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      if (c2 &gt;= 0x30 &amp;&amp; c2 &lt;= 0x39) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        if (n &gt;= 3) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          unsigned char c3 = s[2];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          if (c3 &gt;= 0x81 &amp;&amp; c3 &lt;= 0xfe) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;            if (n &gt;= 4) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;              unsigned char c4 = s[3];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;              if (c4 &gt;= 0x30 &amp;&amp; c4 &lt;= 0x39) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                unsigned int i = (((c1 - 0x81) * 10 + (c2 - 0x30)) * 126 + (c3 - 0x81)) * 10 + (c4 - 0x30);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                if (i &gt;= %d &amp;&amp; i &lt;= %d) {\n&quot;</span>, ranges[0].low, ranges[ranges_count-1].high);
  printf(<span class="enscript-string">&quot;                  unsigned int k1 = 0;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                  unsigned int k2 = %d;\n&quot;</span>, ranges_count-1);
  printf(<span class="enscript-string">&quot;                  while (k1 &lt; k2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    unsigned int k = (k1 + k2) / 2;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    if (i &lt;= %s_charset2uni_ranges[2*k+1])\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;                      k2 = k;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    else if (i &gt;= %s_charset2uni_ranges[2*k+2])\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;                      k1 = k + 1;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                      return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                  {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    unsigned int bitmap_index = i - %s_charset2uni_ranges[2*k1] + %s_ranges[k1].bitmap_offset;\n&quot;</span>, name, name);
  printf(<span class="enscript-string">&quot;                    if ((%s_bitmap[bitmap_index &gt;&gt; 3] &gt;&gt; (bitmap_index &amp; 7)) &amp; 1) {\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;                      unsigned int diff = %s_ranges[k1].diff;\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;                      *pwc = (ucs4_t) (i + diff);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                      return 4;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;                }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;              }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;              return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;            }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;            return RET_TOOFEW(0);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        return RET_TOOFEW(0);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_TOOFEW(0);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_ILSEQ;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);

  printf(<span class="enscript-string">&quot;\n&quot;</span>);

  printf(<span class="enscript-string">&quot;static int\n&quot;</span>);
  printf(<span class="enscript-string">&quot;%s_wctomb (conv_t conv, unsigned char *r, ucs4_t wc, int n)\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (n &gt;= 4) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    unsigned int i = wc;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    if (i &gt;= 0x%04x &amp;&amp; i &lt;= 0x%04x) {\n&quot;</span>, ranges[0].low + ranges[0].diff, ranges[ranges_count-1].high + ranges[ranges_count-1].diff);
  printf(<span class="enscript-string">&quot;      unsigned int k1 = 0;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned int k2 = %d;\n&quot;</span>, ranges_count-1);
  printf(<span class="enscript-string">&quot;      while (k1 &lt; k2) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int k = (k1 + k2) / 2;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        if (i &lt;= %s_uni2charset_ranges[2*k+1])\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;          k2 = k;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        else if (i &gt;= %s_uni2charset_ranges[2*k+2])\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;          k1 = k + 1;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          return RET_ILUNI;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        unsigned int bitmap_index = i - %s_uni2charset_ranges[2*k1] + %s_ranges[k1].bitmap_offset;\n&quot;</span>, name, name);
  printf(<span class="enscript-string">&quot;        if ((%s_bitmap[bitmap_index &gt;&gt; 3] &gt;&gt; (bitmap_index &amp; 7)) &amp; 1) {\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;          unsigned int diff = %s_ranges[k1].diff;\n&quot;</span>, name);
  printf(<span class="enscript-string">&quot;          i -= diff;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          r[3] = (i %% 10) + 0x30; i = i / 10;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          r[2] = (i %% 126) + 0x81; i = i / 126;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          r[1] = (i %% 10) + 0x30; i = i / 10;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          r[0] = i + 0x81;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;          return 4;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return RET_ILUNI;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return RET_TOOSMALL;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
}

<span class="enscript-comment">/* JISX0213 specifics */</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">do_jisx0213</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span>* name)
{
  printf(<span class="enscript-string">&quot;#ifndef _JISX0213_H\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#define _JISX0213_H\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;/* JISX0213 plane 1 (= ISO-IR-233) characters are in the range\n&quot;</span>);
  printf(<span class="enscript-string">&quot;   0x{21..7E}{21..7E}.\n&quot;</span>);
  printf(<span class="enscript-string">&quot;   JISX0213 plane 2 (= ISO-IR-229) characters are in the range\n&quot;</span>);
  printf(<span class="enscript-string">&quot;   0x{21,23..25,28,2C..2F,6E..7E}{21..7E}.\n&quot;</span>);
  printf(<span class="enscript-string">&quot;   Together this makes 120 rows of 94 characters.\n&quot;</span>);
  printf(<span class="enscript-string">&quot;*/\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  {
#<span class="enscript-reference">define</span> <span class="enscript-function-name">row_convert</span>(row) \
      ((row) &gt;= 0x121 &amp;&amp; (row) &lt;= 0x17E ? row-289 : <span class="enscript-comment">/* 0..93 */</span>    \
       (row) == 0x221                   ? row-451 : <span class="enscript-comment">/* 94 */</span>       \
       (row) &gt;= 0x223 &amp;&amp; (row) &lt;= 0x225 ? row-452 : <span class="enscript-comment">/* 95..97 */</span>   \
       (row) == 0x228                   ? row-454 : <span class="enscript-comment">/* 98 */</span>       \
       (row) &gt;= 0x22C &amp;&amp; (row) &lt;= 0x22F ? row-457 : <span class="enscript-comment">/* 99..102 */</span>  \
       (row) &gt;= 0x26E &amp;&amp; (row) &lt;= 0x27E ? row-519 : <span class="enscript-comment">/* 103..119 */</span> \
       -1)
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> table[120][94];
    <span class="enscript-type">int</span> pagemin[0x1100];
    <span class="enscript-type">int</span> pagemax[0x1100];
    <span class="enscript-type">int</span> pageidx[0x1100];
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> pagestart[0x1100];
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> pagestart_len = 0;
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> rowc, colc;
      <span class="enscript-keyword">for</span> (rowc = 0; rowc &lt; 120; rowc++)
        <span class="enscript-keyword">for</span> (colc = 0; colc &lt; 94; colc++)
          table[rowc][colc] = 0;
    }
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> page;
      <span class="enscript-keyword">for</span> (page = 0; page &lt; 0x1100; page++)
        pagemin[page] = -1;
      <span class="enscript-keyword">for</span> (page = 0; page &lt; 0x1100; page++)
        pagemax[page] = -1;
      <span class="enscript-keyword">for</span> (page = 0; page &lt; 0x1100; page++)
        pageidx[page] = -1;
    }
    printf(<span class="enscript-string">&quot;static const unsigned short jisx0213_to_ucs_combining[][2] = {\n&quot;</span>);
    {
      <span class="enscript-type">int</span> private_use = 0x0001;
      <span class="enscript-keyword">for</span> (;;) {
        <span class="enscript-type">char</span> line[30];
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> row, col;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ucs;
        memset(line,0,<span class="enscript-keyword">sizeof</span>(line));
        <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot;%[^\n]\n&quot;</span>,line) &lt; 1)
          <span class="enscript-keyword">break</span>;
        assert(line[0]==<span class="enscript-string">'0'</span>);
        assert(line[1]==<span class="enscript-string">'x'</span>);
        assert(isxdigit(line[2]));
        assert(isxdigit(line[3]));
        assert(isxdigit(line[4]));
        assert(isxdigit(line[5]));
        assert(isxdigit(line[6]));
        assert(line[7]==<span class="enscript-string">'\t'</span>);
        line[7] = <span class="enscript-string">'\0'</span>;
        col = strtoul(&amp;line[5],NULL,16);
        line[5] = <span class="enscript-string">'\0'</span>;
        row = strtoul(&amp;line[2],NULL,16);
        <span class="enscript-keyword">if</span> (line[20] != <span class="enscript-string">'\0'</span> &amp;&amp; line[21] == <span class="enscript-string">'\0'</span>) {
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> u1, u2;
          assert(line[8]==<span class="enscript-string">'0'</span>);
          assert(line[9]==<span class="enscript-string">'x'</span>);
          assert(isxdigit(line[10]));
          assert(isxdigit(line[11]));
          assert(isxdigit(line[12]));
          assert(isxdigit(line[13]));
          assert(line[14]==<span class="enscript-string">' '</span>);
          assert(line[15]==<span class="enscript-string">'0'</span>);
          assert(line[16]==<span class="enscript-string">'x'</span>);
          assert(isxdigit(line[17]));
          assert(isxdigit(line[18]));
          assert(isxdigit(line[19]));
          assert(isxdigit(line[20]));
          u2 = strtoul(&amp;line[17],NULL,16);
          line[14] = <span class="enscript-string">'\0'</span>;
          u1 = strtoul(&amp;line[10],NULL,16);
          printf(<span class="enscript-string">&quot;  { 0x%04x, 0x%04x },\n&quot;</span>, u1, u2);
          ucs = private_use++;
        } <span class="enscript-keyword">else</span> {
          assert(line[8]==<span class="enscript-string">'0'</span>);
          assert(line[9]==<span class="enscript-string">'x'</span>);
          assert(isxdigit(line[10]));
          assert(isxdigit(line[11]));
          assert(isxdigit(line[12]));
          assert(isxdigit(line[13]));
          ucs = strtoul(&amp;line[10],NULL,16);
        }
        assert((<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>) row_convert(row) &lt; 120);
        assert((<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>) (col-0x21) &lt; 94);
        table[row_convert(row)][col-0x21] = ucs;
      }
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> rowc, colc;
      <span class="enscript-keyword">for</span> (rowc = 0; rowc &lt; 120; rowc++) {
        <span class="enscript-keyword">for</span> (colc = 0; colc &lt; 94; colc++) {
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> value = table[rowc][colc];
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> page = value &gt;&gt; 8;
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> rest = value &amp; 0xff;
          <span class="enscript-keyword">if</span> (pagemin[page] &lt; 0 || pagemin[page] &gt; rest) pagemin[page] = rest;
          <span class="enscript-keyword">if</span> (pagemax[page] &lt; 0 || pagemax[page] &lt; rest) pagemax[page] = rest;
        }
      }
    }
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = 0;
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x1100; ) {
        <span class="enscript-keyword">if</span> (pagemin[i] &gt;= 0) {
          <span class="enscript-keyword">if</span> (pagemin[i+1] &gt;= 0 &amp;&amp; pagemin[i] &gt;= 0x80 &amp;&amp; pagemax[i+1] &lt; 0x80) {
            <span class="enscript-comment">/* Combine two pages into a single one. */</span>
            assert(pagestart_len &lt; <span class="enscript-keyword">sizeof</span>(pagestart)/<span class="enscript-keyword">sizeof</span>(pagestart[0]));
            pagestart[pagestart_len++] = (i&lt;&lt;8)+0x80;
            pageidx[i] = index;
            pageidx[i+1] = index;
            index++;
            i += 2;
          } <span class="enscript-keyword">else</span> {
            <span class="enscript-comment">/* A single page. */</span>
            assert(pagestart_len &lt; <span class="enscript-keyword">sizeof</span>(pagestart)/<span class="enscript-keyword">sizeof</span>(pagestart[0]));
            pagestart[pagestart_len++] = i&lt;&lt;8;
            pageidx[i] = index;
            index++;
            i += 1;
          }
        } <span class="enscript-keyword">else</span>
          i++;
      }
    }
    printf(<span class="enscript-string">&quot;static const unsigned short jisx0213_to_ucs_main[120 * 94] = {\n&quot;</span>);
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> row;
      <span class="enscript-keyword">for</span> (row = 0; row &lt; 0x300; row++) {
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> rowc = row_convert(row);
        <span class="enscript-keyword">if</span> (rowc != (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>) (-1)) {
          printf(<span class="enscript-string">&quot;  /* 0x%X21..0x%X7E */\n&quot;</span>,row,row);
          {
            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count = 0;
            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> colc;
            <span class="enscript-keyword">for</span> (colc = 0; colc &lt; 94; colc++) {
              <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
              {
                <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> value = table[rowc][colc];
                <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> page = value &gt;&gt; 8;
                <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = pageidx[page];
                assert(value-pagestart[index] &lt; 0x100);
                printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>,(index&lt;&lt;8)|(value-pagestart[index]));
              }
              count++;
              <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot;\n&quot;</span>);
            }
          }
          printf(<span class="enscript-string">&quot;\n&quot;</span>);
        }
      }
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;static const ucs4_t jisx0213_to_ucs_pagestart[] = {\n&quot;</span>);
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count = 0;
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; pagestart_len; i++) {
        <span class="enscript-type">char</span> buf[10];
        <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
        printf(<span class="enscript-string">&quot; &quot;</span>);
        sprintf(buf,<span class="enscript-string">&quot;0x%04x&quot;</span>,pagestart[i]);
        <span class="enscript-keyword">if</span> (strlen(buf) &lt; 7) printf(<span class="enscript-string">&quot;%*s&quot;</span>,7-strlen(buf),<span class="enscript-string">&quot;&quot;</span>);
        printf(<span class="enscript-string">&quot;%s,&quot;</span>,buf);
        count++;
        <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot;\n&quot;</span>);
      }
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">row_convert</span>
  }
  rewind(stdin);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  {
    <span class="enscript-type">int</span> table[0x110000];
    bool pages[0x4400];
    <span class="enscript-type">int</span> maxpage = -1;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> combining_prefixes[100];
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> combining_prefixes_len = 0;
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x110000; i++)
        table[i] = -1;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; 0x4400; i++)
        pages[i] = false;
    }
    <span class="enscript-keyword">for</span> (;;) {
      <span class="enscript-type">char</span> line[30];
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> plane, row, col;
      memset(line,0,<span class="enscript-keyword">sizeof</span>(line));
      <span class="enscript-keyword">if</span> (scanf(<span class="enscript-string">&quot;%[^\n]\n&quot;</span>,line) &lt; 1)
        <span class="enscript-keyword">break</span>;
      assert(line[0]==<span class="enscript-string">'0'</span>);
      assert(line[1]==<span class="enscript-string">'x'</span>);
      assert(isxdigit(line[2]));
      assert(isxdigit(line[3]));
      assert(isxdigit(line[4]));
      assert(isxdigit(line[5]));
      assert(isxdigit(line[6]));
      assert(line[7]==<span class="enscript-string">'\t'</span>);
      line[7] = <span class="enscript-string">'\0'</span>;
      col = strtoul(&amp;line[5],NULL,16);
      line[5] = <span class="enscript-string">'\0'</span>;
      row = strtoul(&amp;line[3],NULL,16);
      line[3] = <span class="enscript-string">'\0'</span>;
      plane = strtoul(&amp;line[2],NULL,16) - 1;
      <span class="enscript-keyword">if</span> (line[20] != <span class="enscript-string">'\0'</span> &amp;&amp; line[21] == <span class="enscript-string">'\0'</span>) {
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> u1, u2;
        assert(line[8]==<span class="enscript-string">'0'</span>);
        assert(line[9]==<span class="enscript-string">'x'</span>);
        assert(isxdigit(line[10]));
        assert(isxdigit(line[11]));
        assert(isxdigit(line[12]));
        assert(isxdigit(line[13]));
        assert(line[14]==<span class="enscript-string">' '</span>);
        assert(line[15]==<span class="enscript-string">'0'</span>);
        assert(line[16]==<span class="enscript-string">'x'</span>);
        assert(isxdigit(line[17]));
        assert(isxdigit(line[18]));
        assert(isxdigit(line[19]));
        assert(isxdigit(line[20]));
        u2 = strtoul(&amp;line[17],NULL,16);
        line[14] = <span class="enscript-string">'\0'</span>;
        u1 = strtoul(&amp;line[10],NULL,16);
        assert(u2 == 0x02E5 || u2 == 0x02E9 || u2 == 0x0300 || u2 == 0x0301
               || u2 == 0x309A);
        assert(combining_prefixes_len &lt; <span class="enscript-keyword">sizeof</span>(combining_prefixes)/<span class="enscript-keyword">sizeof</span>(combining_prefixes[0]));
        combining_prefixes[combining_prefixes_len++] = u1;
      } <span class="enscript-keyword">else</span> {
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ucs;
        assert(line[8]==<span class="enscript-string">'0'</span>);
        assert(line[9]==<span class="enscript-string">'x'</span>);
        assert(isxdigit(line[10]));
        assert(isxdigit(line[11]));
        assert(isxdigit(line[12]));
        assert(isxdigit(line[13]));
        ucs = strtoul(&amp;line[10],NULL,16);
        <span class="enscript-comment">/* Add an entry. */</span>
        assert(plane &lt;= 1);
        assert(row &lt;= 0x7f);
        assert(col &lt;= 0x7f);
        table[ucs] = (plane &lt;&lt; 15) | (row &lt;&lt; 8) | col;
        pages[ucs&gt;&gt;6] = true;
        <span class="enscript-keyword">if</span> (maxpage &lt; 0 || (ucs&gt;&gt;6) &gt; maxpage) maxpage = ucs&gt;&gt;6;
      }
    }
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt; combining_prefixes_len; i++) {
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> u1 = combining_prefixes[i];
        assert(table[u1] &gt;= 0);
        table[u1] |= 0x0080;
      }
    }
    printf(<span class="enscript-string">&quot;static const short jisx0213_from_ucs_level1[%d] = {\n&quot;</span>,maxpage+1);
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> index = 0;
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt;= maxpage; i++) {
        <span class="enscript-keyword">if</span> ((i % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
        <span class="enscript-keyword">if</span> (pages[i]) {
          printf(<span class="enscript-string">&quot; %3u,&quot;</span>,index);
          index++;
        } <span class="enscript-keyword">else</span> {
          printf(<span class="enscript-string">&quot; %3d,&quot;</span>,-1);
        }
        <span class="enscript-keyword">if</span> (((i+1) % 8) == 0) printf(<span class="enscript-string">&quot;\n&quot;</span>);
      }
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    #<span class="enscript-keyword">if</span> 0 <span class="enscript-comment">/* Dense array */</span>
    printf(<span class="enscript-string">&quot;static const unsigned short jisx0213_from_ucs_level2[] = {\n&quot;</span>);
    {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
      <span class="enscript-keyword">for</span> (i = 0; i &lt;= maxpage; i++) {
        <span class="enscript-keyword">if</span> (pages[i]) {
          printf(<span class="enscript-string">&quot;  /* 0x%04X */\n&quot;</span>,i&lt;&lt;6);
          {
            <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> j;
            <span class="enscript-keyword">for</span> (j = 0; j &lt; 0x40; ) {
              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ucs = (i&lt;&lt;6)+j;
              <span class="enscript-type">int</span> value = table[ucs];
              <span class="enscript-keyword">if</span> (value &lt; 0) value = 0;
              <span class="enscript-keyword">if</span> ((j % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
              printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>,value);
              j++;
              <span class="enscript-keyword">if</span> ((j % 8) == 0) printf(<span class="enscript-string">&quot;\n&quot;</span>);
            }
          }
        }
      }
    }
    printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    #<span class="enscript-keyword">else</span> <span class="enscript-comment">/* Sparse array */</span>
    {
      <span class="enscript-type">int</span> summary_indx[0x11000];
      <span class="enscript-type">int</span> summary_used[0x11000];
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i, k, indx;
      printf(<span class="enscript-string">&quot;static const unsigned short jisx0213_from_ucs_level2_data[] = {\n&quot;</span>);
      <span class="enscript-comment">/* Fill summary_indx[] and summary_used[]. */</span>
      indx = 0;
      <span class="enscript-keyword">for</span> (i = 0, k = 0; i &lt;= maxpage; i++) {
        <span class="enscript-keyword">if</span> (pages[i]) {
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> j1, j2;
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> count = 0;
          printf(<span class="enscript-string">&quot;  /* 0x%04X */\n&quot;</span>,i&lt;&lt;6);
          <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 4; j1++) {
            summary_indx[4*k+j1] = indx;
            summary_used[4*k+j1] = 0;
            <span class="enscript-keyword">for</span> (j2 = 0; j2 &lt; 16; j2++) {
              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> j = 16*j1+j2;
              <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> ucs = (i&lt;&lt;6)+j;
              <span class="enscript-type">int</span> value = table[ucs];
              <span class="enscript-keyword">if</span> (value &lt; 0) value = 0;
              <span class="enscript-keyword">if</span> (value &gt; 0) {
                summary_used[4*k+j1] |= (1 &lt;&lt; j2);
                <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot; &quot;</span>);
                printf(<span class="enscript-string">&quot; 0x%04x,&quot;</span>,value);
                count++;
                <span class="enscript-keyword">if</span> ((count % 8) == 0) printf(<span class="enscript-string">&quot;\n&quot;</span>);
                indx++;
              }
            }
          }
          <span class="enscript-keyword">if</span> ((count % 8) &gt; 0)
            printf(<span class="enscript-string">&quot;\n&quot;</span>);
          k++;
        }
      }
      printf(<span class="enscript-string">&quot;};\n&quot;</span>);
      printf(<span class="enscript-string">&quot;\n&quot;</span>);
      printf(<span class="enscript-string">&quot;static const Summary16 jisx0213_from_ucs_level2_2indx[] = {\n&quot;</span>);
      <span class="enscript-keyword">for</span> (i = 0, k = 0; i &lt;= maxpage; i++) {
        <span class="enscript-keyword">if</span> (pages[i]) {
          <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> j1;
          printf(<span class="enscript-string">&quot;  /* 0x%04X */\n&quot;</span>,i&lt;&lt;6);
          printf(<span class="enscript-string">&quot; &quot;</span>);
          <span class="enscript-keyword">for</span> (j1 = 0; j1 &lt; 4; j1++) {
            printf(<span class="enscript-string">&quot; { %4d, 0x%04x },&quot;</span>, summary_indx[4*k+j1], summary_used[4*k+j1]);
          }
          printf(<span class="enscript-string">&quot;\n&quot;</span>);
          k++;
        }
      }
      printf(<span class="enscript-string">&quot;};\n&quot;</span>);
    }
    #endif
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
  }
  printf(<span class="enscript-string">&quot;#ifdef __GNUC__\n&quot;</span>);
  printf(<span class="enscript-string">&quot;__inline\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#ifdef __cplusplus\n&quot;</span>);
  printf(<span class="enscript-string">&quot;inline\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#endif\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#endif\n&quot;</span>);
  printf(<span class="enscript-string">&quot;static ucs4_t jisx0213_to_ucs4 (unsigned int row, unsigned int col)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  ucs4_t val;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (row &gt;= 0x121 &amp;&amp; row &lt;= 0x17e)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 289;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else if (row == 0x221)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 451;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else if (row &gt;= 0x223 &amp;&amp; row &lt;= 0x225)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 452;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else if (row == 0x228)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 454;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else if (row &gt;= 0x22c &amp;&amp; row &lt;= 0x22f)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 457;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else if (row &gt;= 0x26e &amp;&amp; row &lt;= 0x27e)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    row -= 519;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return 0x0000;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (col &gt;= 0x21 &amp;&amp; col &lt;= 0x7e)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    col -= 0x21;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    return 0x0000;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  val = jisx0213_to_ucs_main[row * 94 + col];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  val = jisx0213_to_ucs_pagestart[val &gt;&gt; 8] + (val &amp; 0xff);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (val == 0xfffd)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    val = 0x0000;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return val;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#ifdef __GNUC__\n&quot;</span>);
  printf(<span class="enscript-string">&quot;__inline\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#else\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#ifdef __cplusplus\n&quot;</span>);
  printf(<span class="enscript-string">&quot;inline\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#endif\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#endif\n&quot;</span>);
  printf(<span class="enscript-string">&quot;static unsigned short ucs4_to_jisx0213 (ucs4_t ucs)\n&quot;</span>);
  printf(<span class="enscript-string">&quot;{\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  if (ucs &lt; (sizeof(jisx0213_from_ucs_level1)/sizeof(jisx0213_from_ucs_level1[0])) &lt;&lt; 6) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    int index1 = jisx0213_from_ucs_level1[ucs &gt;&gt; 6];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    if (index1 &gt;= 0)&quot;</span>);
  #<span class="enscript-keyword">if</span> 0 <span class="enscript-comment">/* Dense array */</span>
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      return jisx0213_from_ucs_level2[(index1 &lt;&lt; 6) + (ucs &amp; 0x3f)];\n&quot;</span>);
  #<span class="enscript-keyword">else</span> <span class="enscript-comment">/* Sparse array */</span>
  printf(<span class="enscript-string">&quot; {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      const Summary16 *summary = &amp;jisx0213_from_ucs_level2_2indx[((index1 &lt;&lt; 6) + (ucs &amp; 0x3f)) &gt;&gt; 4];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned short used = summary-&gt;used;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      unsigned int i = ucs &amp; 0x0f;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      if (used &amp; ((unsigned short) 1 &lt;&lt; i)) {\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        /* Keep in `used' only the bits 0..i-1. */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used &amp;= ((unsigned short) 1 &lt;&lt; i) - 1;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        /* Add `summary-&gt;indx' and the number of bits set in `used'. */\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x5555) + ((used &amp; 0xaaaa) &gt;&gt; 1);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x3333) + ((used &amp; 0xcccc) &gt;&gt; 2);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x0f0f) + ((used &amp; 0xf0f0) &gt;&gt; 4);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        used = (used &amp; 0x00ff) + (used &gt;&gt; 8);\n&quot;</span>);
  printf(<span class="enscript-string">&quot;        return jisx0213_from_ucs_level2_data[summary-&gt;indx + used];\n&quot;</span>);
  printf(<span class="enscript-string">&quot;      };\n&quot;</span>);
  printf(<span class="enscript-string">&quot;    };\n&quot;</span>);
  #endif
  printf(<span class="enscript-string">&quot;  }\n&quot;</span>);
  printf(<span class="enscript-string">&quot;  return 0x0000;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;}\n&quot;</span>);
  printf(<span class="enscript-string">&quot;\n&quot;</span>);
  printf(<span class="enscript-string">&quot;#endif /* _JISX0213_H */\n&quot;</span>);
}

<span class="enscript-comment">/* Main program */</span>

<span class="enscript-type">int</span> <span class="enscript-function-name">main</span> (<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> *argv[])
{
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* charsetname;
  <span class="enscript-type">const</span> <span class="enscript-type">char</span>* name;

  <span class="enscript-keyword">if</span> (argc != 3)
    exit(1);
  charsetname = argv[1];
  name = argv[2];

  output_title(charsetname);

  <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;gb2312&quot;</span>)
      || !strcmp(name,<span class="enscript-string">&quot;isoir165ext&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;gb12345ext&quot;</span>)
      || !strcmp(name,<span class="enscript-string">&quot;jisx0208&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;jisx0212&quot;</span>))
    do_normal(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;cns11643_1&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;cns11643_2&quot;</span>)
           || !strcmp(name,<span class="enscript-string">&quot;cns11643_3&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;cns11643_4a&quot;</span>)
           || !strcmp(name,<span class="enscript-string">&quot;cns11643_4b&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;cns11643_5&quot;</span>)
           || !strcmp(name,<span class="enscript-string">&quot;cns11643_6&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;cns11643_7&quot;</span>)
           || !strcmp(name,<span class="enscript-string">&quot;cns11643_15&quot;</span>))
    do_normal_only_charset2uni(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;cns11643_inv&quot;</span>))
    do_cns11643_only_uni2charset(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;gbkext1&quot;</span>))
    do_gbk1_only_charset2uni(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;gbkext2&quot;</span>))
    do_gbk2_only_charset2uni(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;gbkext_inv&quot;</span>))
    do_gbk1_only_uni2charset(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;cp936ext&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;gb18030ext&quot;</span>))
    do_gbk1(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;ksc5601&quot;</span>))
    do_ksc5601(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;uhc_1&quot;</span>))
    do_uhc_1(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;uhc_2&quot;</span>))
    do_uhc_2(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;big5&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;cp950ext&quot;</span>))
    do_big5(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;hkscs1999&quot;</span>) || !strcmp(name,<span class="enscript-string">&quot;hkscs2001&quot;</span>)
           || !strcmp(name,<span class="enscript-string">&quot;hkscs2004&quot;</span>))
    do_hkscs(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;johab_hangul&quot;</span>))
    do_johab_hangul(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;cp932ext&quot;</span>))
    do_sjis(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;gb18030uni&quot;</span>))
    do_gb18030uni(name);
  <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(name,<span class="enscript-string">&quot;jisx0213&quot;</span>))
    do_jisx0213(name);
  <span class="enscript-keyword">else</span>
    exit(1);

  <span class="enscript-keyword">return</span> 0;
}
</pre>
<hr />
</body></html>