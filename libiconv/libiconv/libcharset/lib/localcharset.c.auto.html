<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>localcharset.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">localcharset.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* Determine a canonical name for the current locale's character encoding.

   Copyright (C) 2000-2006 Free Software Foundation, Inc.

   This program is free software; you can redistribute it and/or modify it
   under the terms of the GNU Library General Public License as published
   by the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Library General Public License for more details.

   You should have received a copy of the GNU Library General Public
   License along with this program; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,
   USA.  */</span>

<span class="enscript-comment">/* Written by Bruno Haible &lt;<a href="mailto:bruno@clisp.org">bruno@clisp.org</a>&gt;.  */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">HAVE_CONFIG_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;config.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* Specification.  */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;localcharset.h&quot;</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_STDDEF_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;stddef.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_STRING_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">else</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;strings.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_STDLIB_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">_WIN32</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__WIN32__</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">WIN32_NATIVE</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__EMX__</span>
<span class="enscript-comment">/* Assume EMX program runs on OS/2, even if compiled under DOS.  */</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">OS2</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span>
# <span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_LANGINFO_CODESET</span>
#  <span class="enscript-reference">include</span> <span class="enscript-string">&lt;langinfo.h&gt;</span>
# <span class="enscript-reference">else</span>
#  <span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_SETLOCALE</span>
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;locale.h&gt;</span>
#  <span class="enscript-reference">endif</span>
# <span class="enscript-reference">endif</span>
# <span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__CYGWIN__</span>
#  <span class="enscript-reference">define</span> <span class="enscript-variable-name">WIN32_LEAN_AND_MEAN</span>
#  <span class="enscript-reference">include</span> <span class="enscript-string">&lt;windows.h&gt;</span>
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">elif</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">WIN32_LEAN_AND_MEAN</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;windows.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">OS2</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">INCL_DOS</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;os2.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">ENABLE_RELOCATABLE</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&quot;relocatable.h&quot;</span>
#<span class="enscript-reference">else</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">relocate</span>(pathname) (pathname)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">_WIN32</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__WIN32__</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__CYGWIN__</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__EMX__</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__DJGPP__</span>
  <span class="enscript-comment">/* Win32, Cygwin, OS/2, DOS */</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">ISSLASH</span>(C) ((C) == <span class="enscript-string">'/'</span> || (C) == <span class="enscript-string">'\\'</span>)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">DIRECTORY_SEPARATOR</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">DIRECTORY_SEPARATOR</span> <span class="enscript-string">'/'</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">ISSLASH</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">ISSLASH</span>(C) ((C) == DIRECTORY_SEPARATOR)
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_DECL_GETC_UNLOCKED</span>
# <span class="enscript-reference">undef</span> <span class="enscript-variable-name">getc</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">getc</span> getc_unlocked
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* The following static variable is declared 'volatile' to avoid a
   possible multithread problem in the function get_charset_aliases. If we
   are running in a threaded environment, and if two threads initialize
   'charset_aliases' simultaneously, both will produce the same value,
   and everything will be ok if the two assignments to 'charset_aliases'
   are atomic. But I don't know what will happen if the two assignments mix.  */</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">__STDC__</span> != 1
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">volatile</span> <span class="enscript-comment">/* empty */</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-comment">/* Pointer to the contents of the charset.alias file, if it has already been
   read, else NULL.  Its format is:
   ALIAS_1 '\0' CANONICAL_1 '\0' ... ALIAS_n '\0' CANONICAL_n '\0' '\0'  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> * <span class="enscript-type">volatile</span> charset_aliases;

<span class="enscript-comment">/* Return a pointer to the contents of the charset.alias file.  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">get_charset_aliases</span> (<span class="enscript-type">void</span>)
{
  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *cp;

  cp = charset_aliases;
  <span class="enscript-keyword">if</span> (cp == NULL)
    {
#<span class="enscript-reference">if</span> !(<span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">VMS</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__CYGWIN__</span>)
      FILE *fp;
      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dir;
      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *base = <span class="enscript-string">&quot;charset.alias&quot;</span>;
      <span class="enscript-type">char</span> *file_name;

      <span class="enscript-comment">/* Make it possible to override the charset.alias location.  This is
	 necessary for running the testsuite before &quot;make install&quot;.  */</span>
      dir = getenv (<span class="enscript-string">&quot;CHARSETALIASDIR&quot;</span>);
      <span class="enscript-keyword">if</span> (dir == NULL || dir[0] == <span class="enscript-string">'\0'</span>)
	dir = relocate (LIBDIR);

      <span class="enscript-comment">/* Concatenate dir and base into freshly allocated file_name.  */</span>
      {
	size_t dir_len = strlen (dir);
	size_t base_len = strlen (base);
	<span class="enscript-type">int</span> add_slash = (dir_len &gt; 0 &amp;&amp; !ISSLASH (dir[dir_len - 1]));
	file_name = (<span class="enscript-type">char</span> *) malloc (dir_len + add_slash + base_len + 1);
	<span class="enscript-keyword">if</span> (file_name != NULL)
	  {
	    memcpy (file_name, dir, dir_len);
	    <span class="enscript-keyword">if</span> (add_slash)
	      file_name[dir_len] = DIRECTORY_SEPARATOR;
	    memcpy (file_name + dir_len + add_slash, base, base_len + 1);
	  }
      }

      <span class="enscript-keyword">if</span> (file_name == NULL || (fp = fopen (file_name, <span class="enscript-string">&quot;r&quot;</span>)) == NULL)
	<span class="enscript-comment">/* Out of memory or file not found, treat it as empty.  */</span>
	cp = <span class="enscript-string">&quot;&quot;</span>;
      <span class="enscript-keyword">else</span>
	{
	  <span class="enscript-comment">/* Parse the file's contents.  */</span>
	  <span class="enscript-type">char</span> *res_ptr = NULL;
	  size_t res_size = 0;

	  <span class="enscript-keyword">for</span> (;;)
	    {
	      <span class="enscript-type">int</span> c;
	      <span class="enscript-type">char</span> buf1[50+1];
	      <span class="enscript-type">char</span> buf2[50+1];
	      size_t l1, l2;
	      <span class="enscript-type">char</span> *old_res_ptr;

	      c = getc (fp);
	      <span class="enscript-keyword">if</span> (c == EOF)
		<span class="enscript-keyword">break</span>;
	      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'\n'</span> || c == <span class="enscript-string">' '</span> || c == <span class="enscript-string">'\t'</span>)
		<span class="enscript-keyword">continue</span>;
	      <span class="enscript-keyword">if</span> (c == <span class="enscript-string">'#'</span>)
		{
		  <span class="enscript-comment">/* Skip comment, to end of line.  */</span>
		  <span class="enscript-keyword">do</span>
		    c = getc (fp);
		  <span class="enscript-keyword">while</span> (!(c == EOF || c == <span class="enscript-string">'\n'</span>));
		  <span class="enscript-keyword">if</span> (c == EOF)
		    <span class="enscript-keyword">break</span>;
		  <span class="enscript-keyword">continue</span>;
		}
	      ungetc (c, fp);
	      <span class="enscript-keyword">if</span> (fscanf (fp, <span class="enscript-string">&quot;%50s %50s&quot;</span>, buf1, buf2) &lt; 2)
		<span class="enscript-keyword">break</span>;
	      l1 = strlen (buf1);
	      l2 = strlen (buf2);
	      old_res_ptr = res_ptr;
	      <span class="enscript-keyword">if</span> (res_size == 0)
		{
		  res_size = l1 + 1 + l2 + 1;
		  res_ptr = (<span class="enscript-type">char</span> *) malloc (res_size + 1);
		}
	      <span class="enscript-keyword">else</span>
		{
		  res_size += l1 + 1 + l2 + 1;
		  res_ptr = (<span class="enscript-type">char</span> *) realloc (res_ptr, res_size + 1);
		}
	      <span class="enscript-keyword">if</span> (res_ptr == NULL)
		{
		  <span class="enscript-comment">/* Out of memory. */</span>
		  res_size = 0;
		  <span class="enscript-keyword">if</span> (old_res_ptr != NULL)
		    free (old_res_ptr);
		  <span class="enscript-keyword">break</span>;
		}
	      strcpy (res_ptr + res_size - (l2 + 1) - (l1 + 1), buf1);
	      strcpy (res_ptr + res_size - (l2 + 1), buf2);
	    }
	  fclose (fp);
	  <span class="enscript-keyword">if</span> (res_size == 0)
	    cp = <span class="enscript-string">&quot;&quot;</span>;
	  <span class="enscript-keyword">else</span>
	    {
	      *(res_ptr + res_size) = <span class="enscript-string">'\0'</span>;
	      cp = res_ptr;
	    }
	}

      <span class="enscript-keyword">if</span> (file_name != NULL)
	free (file_name);

#<span class="enscript-reference">else</span>

# <span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">VMS</span>
      <span class="enscript-comment">/* To avoid the troubles of an extra file charset.alias_vms in the
	 sources of many GNU packages, simply inline the aliases here.  */</span>
      <span class="enscript-comment">/* The list of encodings is taken from the OpenVMS 7.3-1 documentation
	 &quot;Compaq C Run-Time Library Reference Manual for OpenVMS systems&quot;
	 section 10.7 &quot;Handling Different Character Sets&quot;.  */</span>
      cp = <span class="enscript-string">&quot;ISO8859-1&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-1&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;ISO8859-2&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-2&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;ISO8859-5&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-5&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;ISO8859-7&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-7&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;ISO8859-8&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-8&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;ISO8859-9&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-9&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-comment">/* Japanese */</span>
	   <span class="enscript-string">&quot;eucJP&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-JP&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;SJIS&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;SHIFT_JIS&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;DECKANJI&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;DEC-KANJI&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;SDECKANJI&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-JP&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-comment">/* Chinese */</span>
	   <span class="enscript-string">&quot;eucTW&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-TW&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;DECHANYU&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;DEC-HANYU&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;DECHANZI&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;GB2312&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-comment">/* Korean */</span>
	   <span class="enscript-string">&quot;DECKOREAN&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-KR&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>;
# <span class="enscript-reference">endif</span>

# <span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__CYGWIN__</span>
      <span class="enscript-comment">/* To avoid the troubles of installing a separate file in the same
	 directory as the DLL and of retrieving the DLL's directory at
	 runtime, simply inline the aliases here.  */</span>

      cp = <span class="enscript-string">&quot;CP936&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;GBK&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP1361&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;JOHAB&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP20127&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ASCII&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP20866&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;KOI8-R&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP20936&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;GB2312&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP21866&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;KOI8-RU&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28591&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-1&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28592&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-2&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28593&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-3&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28594&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-4&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28595&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-5&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28596&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-6&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28597&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-7&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28598&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-8&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28599&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-9&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP28605&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-15&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP38598&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;ISO-8859-8&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP51932&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-JP&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP51936&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;GB2312&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP51949&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-KR&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP51950&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;EUC-TW&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP54936&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;GB18030&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>
	   <span class="enscript-string">&quot;CP65001&quot;</span> <span class="enscript-string">&quot;\0&quot;</span> <span class="enscript-string">&quot;UTF-8&quot;</span> <span class="enscript-string">&quot;\0&quot;</span>;
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>

      charset_aliases = cp;
    }

  <span class="enscript-keyword">return</span> cp;
}

<span class="enscript-comment">/* Determine the current locale's character encoding, and canonicalize it
   into one of the canonical names listed in config.charset.
   The result must not be freed; it is statically allocated.
   If the canonical name cannot be determined, the result is a non-canonical
   name.  */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">STATIC</span>
STATIC
#<span class="enscript-reference">endif</span>
<span class="enscript-type">const</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">locale_charset</span> (<span class="enscript-type">void</span>)
{
  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *codeset;
  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *aliases;

#<span class="enscript-reference">if</span> !(<span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">OS2</span>)

# <span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_LANGINFO_CODESET</span>

  <span class="enscript-comment">/* Most systems support nl_langinfo (CODESET) nowadays.  */</span>
  codeset = nl_langinfo (CODESET);

#  <span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__CYGWIN__</span>
  <span class="enscript-comment">/* Cygwin 2006 does not have locales.  nl_langinfo (CODESET) always
     returns &quot;US-ASCII&quot;.  As long as this is not fixed, return the suffix
     of the locale name from the environment variables (if present) or
     the codepage as a number.  */</span>
  <span class="enscript-keyword">if</span> (codeset != NULL &amp;&amp; strcmp (codeset, <span class="enscript-string">&quot;US-ASCII&quot;</span>) == 0)
    {
      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *locale;
      <span class="enscript-type">static</span> <span class="enscript-type">char</span> buf[2 + 10 + 1];

      locale = getenv (<span class="enscript-string">&quot;LC_ALL&quot;</span>);
      <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
	{
	  locale = getenv (<span class="enscript-string">&quot;LC_CTYPE&quot;</span>);
	  <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
	    locale = getenv (<span class="enscript-string">&quot;LANG&quot;</span>);
	}
      <span class="enscript-keyword">if</span> (locale != NULL &amp;&amp; locale[0] != <span class="enscript-string">'\0'</span>)
	{
	  <span class="enscript-comment">/* If the locale name contains an encoding after the dot, return
	     it.  */</span>
	  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dot = strchr (locale, <span class="enscript-string">'.'</span>);

	  <span class="enscript-keyword">if</span> (dot != NULL)
	    {
	      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *modifier;

	      dot++;
	      <span class="enscript-comment">/* Look for the possible @... trailer and remove it, if any.  */</span>
	      modifier = strchr (dot, <span class="enscript-string">'@'</span>);
	      <span class="enscript-keyword">if</span> (modifier == NULL)
		<span class="enscript-keyword">return</span> dot;
	      <span class="enscript-keyword">if</span> (modifier - dot &lt; <span class="enscript-keyword">sizeof</span> (buf))
		{
		  memcpy (buf, dot, modifier - dot);
		  buf [modifier - dot] = <span class="enscript-string">'\0'</span>;
		  <span class="enscript-keyword">return</span> buf;
		}
	    }
	}

      <span class="enscript-comment">/* Woe32 has a function returning the locale's codepage as a number.  */</span>
      sprintf (buf, <span class="enscript-string">&quot;CP%u&quot;</span>, GetACP ());
      codeset = buf;
    }
#  <span class="enscript-reference">endif</span>

# <span class="enscript-reference">else</span>

  <span class="enscript-comment">/* On old systems which lack it, use setlocale or getenv.  */</span>
  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *locale = NULL;

  <span class="enscript-comment">/* But most old systems don't have a complete set of locales.  Some
     (like SunOS 4 or DJGPP) have only the C locale.  Therefore we don't
     use setlocale here; it would return &quot;C&quot; when it doesn't support the
     locale name the user has set.  */</span>
#  <span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_SETLOCALE</span> &amp;&amp; 0
  locale = setlocale (LC_CTYPE, NULL);
#  <span class="enscript-reference">endif</span>
  <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
    {
      locale = getenv (<span class="enscript-string">&quot;LC_ALL&quot;</span>);
      <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
	{
	  locale = getenv (<span class="enscript-string">&quot;LC_CTYPE&quot;</span>);
	  <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
	    locale = getenv (<span class="enscript-string">&quot;LANG&quot;</span>);
	}
    }

  <span class="enscript-comment">/* On some old systems, one used to set locale = &quot;iso8859_1&quot;. On others,
     you set it to &quot;language_COUNTRY.charset&quot;. In any case, we resolve it
     through the charset.alias file.  */</span>
  codeset = locale;

# <span class="enscript-reference">endif</span>

#<span class="enscript-reference">elif</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">WIN32_NATIVE</span>

  <span class="enscript-type">static</span> <span class="enscript-type">char</span> buf[2 + 10 + 1];

  <span class="enscript-comment">/* Woe32 has a function returning the locale's codepage as a number.  */</span>
  sprintf (buf, <span class="enscript-string">&quot;CP%u&quot;</span>, GetACP ());
  codeset = buf;

#<span class="enscript-reference">elif</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">OS2</span>

  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *locale;
  <span class="enscript-type">static</span> <span class="enscript-type">char</span> buf[2 + 10 + 1];
  ULONG cp[3];
  ULONG cplen;

  <span class="enscript-comment">/* Allow user to override the codeset, as set in the operating system,
     with standard language environment variables.  */</span>
  locale = getenv (<span class="enscript-string">&quot;LC_ALL&quot;</span>);
  <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
    {
      locale = getenv (<span class="enscript-string">&quot;LC_CTYPE&quot;</span>);
      <span class="enscript-keyword">if</span> (locale == NULL || locale[0] == <span class="enscript-string">'\0'</span>)
	locale = getenv (<span class="enscript-string">&quot;LANG&quot;</span>);
    }
  <span class="enscript-keyword">if</span> (locale != NULL &amp;&amp; locale[0] != <span class="enscript-string">'\0'</span>)
    {
      <span class="enscript-comment">/* If the locale name contains an encoding after the dot, return it.  */</span>
      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dot = strchr (locale, <span class="enscript-string">'.'</span>);

      <span class="enscript-keyword">if</span> (dot != NULL)
	{
	  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *modifier;

	  dot++;
	  <span class="enscript-comment">/* Look for the possible @... trailer and remove it, if any.  */</span>
	  modifier = strchr (dot, <span class="enscript-string">'@'</span>);
	  <span class="enscript-keyword">if</span> (modifier == NULL)
	    <span class="enscript-keyword">return</span> dot;
	  <span class="enscript-keyword">if</span> (modifier - dot &lt; <span class="enscript-keyword">sizeof</span> (buf))
	    {
	      memcpy (buf, dot, modifier - dot);
	      buf [modifier - dot] = <span class="enscript-string">'\0'</span>;
	      <span class="enscript-keyword">return</span> buf;
	    }
	}

      <span class="enscript-comment">/* Resolve through the charset.alias file.  */</span>
      codeset = locale;
    }
  <span class="enscript-keyword">else</span>
    {
      <span class="enscript-comment">/* OS/2 has a function returning the locale's codepage as a number.  */</span>
      <span class="enscript-keyword">if</span> (DosQueryCp (<span class="enscript-keyword">sizeof</span> (cp), cp, &amp;cplen))
	codeset = <span class="enscript-string">&quot;&quot;</span>;
      <span class="enscript-keyword">else</span>
	{
	  sprintf (buf, <span class="enscript-string">&quot;CP%u&quot;</span>, cp[0]);
	  codeset = buf;
	}
    }

#<span class="enscript-reference">endif</span>

  <span class="enscript-keyword">if</span> (codeset == NULL)
    <span class="enscript-comment">/* The canonical name cannot be determined.  */</span>
    codeset = <span class="enscript-string">&quot;&quot;</span>;

  <span class="enscript-comment">/* Resolve alias. */</span>
  <span class="enscript-keyword">for</span> (aliases = get_charset_aliases ();
       *aliases != <span class="enscript-string">'\0'</span>;
       aliases += strlen (aliases) + 1, aliases += strlen (aliases) + 1)
    <span class="enscript-keyword">if</span> (strcmp (codeset, aliases) == 0
	|| (aliases[0] == <span class="enscript-string">'*'</span> &amp;&amp; aliases[1] == <span class="enscript-string">'\0'</span>))
      {
	codeset = aliases + strlen (aliases) + 1;
	<span class="enscript-keyword">break</span>;
      }

  <span class="enscript-comment">/* Don't return an empty string.  GNU libc and GNU libiconv interpret
     the empty string as denoting &quot;the locale's character encoding&quot;,
     thus GNU libiconv would call this function a second time.  */</span>
  <span class="enscript-keyword">if</span> (codeset[0] == <span class="enscript-string">'\0'</span>)
    codeset = <span class="enscript-string">&quot;ASCII&quot;</span>;

  <span class="enscript-keyword">return</span> codeset;
}
</pre>
<hr />
</body></html>