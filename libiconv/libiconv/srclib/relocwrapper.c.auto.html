<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>relocwrapper.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">relocwrapper.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* Relocating wrapper program.
   Copyright (C) 2003, 2005 Free Software Foundation, Inc.
   Written by Bruno Haible &lt;<a href="mailto:bruno@clisp.org">bruno@clisp.org</a>&gt;, 2003.

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software Foundation,
   Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */</span>

<span class="enscript-comment">/* Dependencies:
   relocwrapper
    -&gt; progname
    -&gt; progreloc
        -&gt; xreadlink
           -&gt; readlink
        -&gt; canonicalize
           -&gt; allocsa
    -&gt; relocatable
    -&gt; setenv
       -&gt; allocsa
    -&gt; strerror

   Macros that need to be set while compiling this file:
     - ENABLE_RELOCATABLE 1
     - INSTALLPREFIX the base installation directory
     - INSTALLDIR the directory into which this program is installed
     - LIBPATHVAR the platform dependent runtime library path variable
     - LIBDIRS a comma-terminated list of strings representing the list of
       directories that contain the libraries at installation time

   We don't want to internationalize this wrapper because then it would
   depend on libintl and therefore need relocation itself.  So use only
   libc functions, no gettext(), no error(), no xmalloc(), no xsetenv().
 */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">HAVE_CONFIG_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;config.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_UNISTD_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;progname.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;relocatable.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;setenv.h&quot;</span>

<span class="enscript-comment">/* Return a copy of the filename, with an extra &quot;.bin&quot; at the end.
   More generally, it replaces &quot;${EXEEXT}&quot; at the end with &quot;.bin${EXEEXT}&quot;.  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">char</span> *
<span class="enscript-function-name">add_dotbin</span> (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *filename)
{
  size_t filename_len = strlen (filename);
  <span class="enscript-type">char</span> *result = (<span class="enscript-type">char</span> *) malloc (filename_len + 4 + 1);

  <span class="enscript-keyword">if</span> (result != NULL)
    {
      <span class="enscript-keyword">if</span> (<span class="enscript-keyword">sizeof</span> (EXEEXT) &gt; <span class="enscript-keyword">sizeof</span> (<span class="enscript-string">&quot;&quot;</span>))
	{
	  <span class="enscript-comment">/* EXEEXT handling.  */</span>
	  <span class="enscript-type">const</span> size_t exeext_len = <span class="enscript-keyword">sizeof</span> (EXEEXT) - <span class="enscript-keyword">sizeof</span> (<span class="enscript-string">&quot;&quot;</span>);
	  <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> exeext[] = EXEEXT;
	  <span class="enscript-keyword">if</span> (filename_len &gt; exeext_len)
	    {
	      <span class="enscript-comment">/* Compare using an inlined copy of c_strncasecmp(), because
		 the filenames may have undergone a case conversion since
		 they were packaged.  In other words, EXEEXT may be &quot;.exe&quot;
		 on one system and &quot;.EXE&quot; on another.  */</span>
	      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *s1 = filename + filename_len - exeext_len;
	      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *s2 = exeext;
	      <span class="enscript-keyword">for</span> (; *s1 != <span class="enscript-string">'\0'</span>; s1++, s2++)
		{
		  <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> c1 = *s1;
		  <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> c2 = *s2;
		  <span class="enscript-keyword">if</span> ((c1 &gt;= <span class="enscript-string">'A'</span> &amp;&amp; c1 &lt;= <span class="enscript-string">'Z'</span> ? c1 - <span class="enscript-string">'A'</span> + <span class="enscript-string">'a'</span> : c1)
		      != (c2 &gt;= <span class="enscript-string">'A'</span> &amp;&amp; c2 &lt;= <span class="enscript-string">'Z'</span> ? c2 - <span class="enscript-string">'A'</span> + <span class="enscript-string">'a'</span> : c2))
		    <span class="enscript-keyword">goto</span> <span class="enscript-reference">simple_append</span>;
		}
	      <span class="enscript-comment">/* Insert &quot;.bin&quot; before EXEEXT or its equivalent.  */</span>
	      memcpy (result, filename, filename_len - exeext_len);
	      memcpy (result + filename_len - exeext_len, <span class="enscript-string">&quot;.bin&quot;</span>, 4);
	      memcpy (result + filename_len - exeext_len + 4,
		      filename + filename_len - exeext_len,
		      exeext_len + 1);
	      <span class="enscript-keyword">return</span> result;
	    }
	}
     <span class="enscript-reference">simple_append</span>:
      <span class="enscript-comment">/* Simply append &quot;.bin&quot;.  */</span>
      memcpy (result, filename, filename_len);
      memcpy (result + filename_len, <span class="enscript-string">&quot;.bin&quot;</span>, 4 + 1);
      <span class="enscript-keyword">return</span> result;
    }
  <span class="enscript-keyword">else</span>
    {
      fprintf (stderr, <span class="enscript-string">&quot;%s: %s\n&quot;</span>, program_name, <span class="enscript-string">&quot;memory exhausted&quot;</span>);
      exit (1);
    }
}

<span class="enscript-comment">/* List of directories that contain the libraries.  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *libdirs[] = { LIBDIRS NULL };
<span class="enscript-comment">/* Verify that at least one directory is given.  */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">int</span> verify1[2 * (<span class="enscript-keyword">sizeof</span> (libdirs) / <span class="enscript-keyword">sizeof</span> (libdirs[0]) &gt; 1) - 1];

<span class="enscript-comment">/* Relocate the list of directories that contain the libraries.  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">relocate_libdirs</span> ()
{
  size_t i;

  <span class="enscript-keyword">for</span> (i = 0; i &lt; <span class="enscript-keyword">sizeof</span> (libdirs) / <span class="enscript-keyword">sizeof</span> (libdirs[0]) - 1; i++)
    libdirs[i] = relocate (libdirs[i]);
}

<span class="enscript-comment">/* Activate the list of directories in the LIBPATHVAR.  */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">activate_libdirs</span> ()
{
  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *old_value;
  size_t total;
  size_t i;
  <span class="enscript-type">char</span> *value;
  <span class="enscript-type">char</span> *p;

  old_value = getenv (LIBPATHVAR);
  <span class="enscript-keyword">if</span> (old_value == NULL)
    old_value = <span class="enscript-string">&quot;&quot;</span>;

  total = 0;
  <span class="enscript-keyword">for</span> (i = 0; i &lt; <span class="enscript-keyword">sizeof</span> (libdirs) / <span class="enscript-keyword">sizeof</span> (libdirs[0]) - 1; i++)
    total += strlen (libdirs[i]) + 1;
  total += strlen (old_value) + 1;

  value = (<span class="enscript-type">char</span> *) malloc (total);
  <span class="enscript-keyword">if</span> (value == NULL)
    {
      fprintf (stderr, <span class="enscript-string">&quot;%s: %s\n&quot;</span>, program_name, <span class="enscript-string">&quot;memory exhausted&quot;</span>);
      exit (1);
    }
  p = value;
  <span class="enscript-keyword">for</span> (i = 0; i &lt; <span class="enscript-keyword">sizeof</span> (libdirs) / <span class="enscript-keyword">sizeof</span> (libdirs[0]) - 1; i++)
    {
      size_t len = strlen (libdirs[i]);
      memcpy (p, libdirs[i], len);
      p += len;
      *p++ = <span class="enscript-string">':'</span>;
    }
  <span class="enscript-keyword">if</span> (old_value[0] != <span class="enscript-string">'\0'</span>)
    strcpy (p, old_value);
  <span class="enscript-keyword">else</span>
    p[-1] = <span class="enscript-string">'\0'</span>;

  <span class="enscript-keyword">if</span> (setenv (LIBPATHVAR, value, 1) &lt; 0)
    {
      fprintf (stderr, <span class="enscript-string">&quot;%s: %s\n&quot;</span>, program_name, <span class="enscript-string">&quot;memory exhausted&quot;</span>);
      exit (1);
    }
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">main</span> (<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> *argv[])
{
  <span class="enscript-type">char</span> *full_program_name;

  <span class="enscript-comment">/* Set the program name and perform preparations for
     get_full_program_name() and relocate().  */</span>
  set_program_name_and_installdir (argv[0], INSTALLPREFIX, INSTALLDIR);

  <span class="enscript-comment">/* Get the full program path.  (Important if accessed through a symlink.)  */</span>
  full_program_name = get_full_program_name ();
  <span class="enscript-keyword">if</span> (full_program_name == NULL)
    full_program_name = argv[0];

  <span class="enscript-comment">/* Invoke the real program, with suffix &quot;.bin&quot;.  */</span>
  argv[0] = add_dotbin (full_program_name);
  relocate_libdirs ();
  activate_libdirs ();
  execv (argv[0], argv);
  fprintf (stderr, <span class="enscript-string">&quot;%s: could not execute %s: %s\n&quot;</span>,
	   program_name, argv[0], strerror (errno));
  exit (127);
}
</pre>
<hr />
</body></html>