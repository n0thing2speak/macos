<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>error.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">error.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* Error handler for noninteractive utilities
   Copyright (C) 1990-1998, 2000-2003, 2004 Free Software Foundation, Inc.
   This file is part of the GNU C Library.

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2, or (at your option)
   any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License along
   with this program; if not, write to the Free Software Foundation,
   Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  */</span>

<span class="enscript-comment">/* Written by David MacKenzie &lt;<a href="mailto:djm@gnu.ai.mit.edu">djm@gnu.ai.mit.edu</a>&gt;.  */</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">HAVE_CONFIG_H</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;config.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;error.h&quot;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">_LIBC</span> &amp;&amp; <span class="enscript-variable-name">ENABLE_NLS</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&quot;gettext.h&quot;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;wchar.h&gt;</span>
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">mbsrtowcs</span> __mbsrtowcs
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">USE_UNLOCKED_IO</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&quot;unlocked-io.h&quot;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">_</span>(String) String
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">/* If NULL, error will flush stdout, then print on stderr the program
   name, a colon and a space.  Otherwise, error will call this
   function without parameters instead.  */</span>
<span class="enscript-function-name">void</span> (*error_print_progname) (<span class="enscript-type">void</span>);

<span class="enscript-comment">/* This variable is incremented each time `error' is called.  */</span>
<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> error_message_count;

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
<span class="enscript-comment">/* In the GNU C library, there is a predefined variable for this.  */</span>

# <span class="enscript-reference">define</span> <span class="enscript-variable-name">program_name</span> program_invocation_name
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>
# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;libio/libioP.h&gt;</span>

<span class="enscript-comment">/* In GNU libc we want do not want to use the common name `error' directly.
   Instead make it a weak alias.  */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">__error</span> (<span class="enscript-type">int</span> status, <span class="enscript-type">int</span> errnum, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *message, ...)
     __attribute__ ((__format__ (__printf__, 3, 4)));
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">__error_at_line</span> (<span class="enscript-type">int</span> status, <span class="enscript-type">int</span> errnum, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *file_name,
			     <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> line_number, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *message,
			     ...)
     __attribute__ ((__format__ (__printf__, 5, 6)));;
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">error</span> __error
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">error_at_line</span> __error_at_line

# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;libio/iolibio.h&gt;</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">fflush</span>(s) INTUSE(_IO_fflush) (s)
# <span class="enscript-reference">undef</span> <span class="enscript-variable-name">putc</span>
# <span class="enscript-reference">define</span> <span class="enscript-function-name">putc</span>(c, fp) INTUSE(_IO_putc) (c, fp)

# <span class="enscript-reference">include</span> <span class="enscript-string">&lt;bits/libc-lock.h&gt;</span>

#<span class="enscript-reference">else</span> <span class="enscript-comment">/* not _LIBC */</span>

# <span class="enscript-reference">if</span> !<span class="enscript-variable-name">HAVE_DECL_STRERROR_R</span> &amp;&amp; <span class="enscript-variable-name">STRERROR_R_CHAR_P</span>
#  <span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">HAVE_DECL_STRERROR_R</span>
<span class="enscript-string">&quot;this configure-time declaration test was not run&quot;</span>
#  <span class="enscript-reference">endif</span>
<span class="enscript-type">char</span> *<span class="enscript-function-name">strerror_r</span> ();
# <span class="enscript-reference">endif</span>

# <span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">SIZE_MAX</span>
#  <span class="enscript-reference">define</span> <span class="enscript-variable-name">SIZE_MAX</span> ((size_t) -1)
# <span class="enscript-reference">endif</span>

<span class="enscript-comment">/* The calling program should define program_name and set it to the
   name of the executing program.  */</span>
<span class="enscript-type">extern</span> <span class="enscript-type">char</span> *program_name;

# <span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_STRERROR_R</span> || <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">strerror_r</span>
#  <span class="enscript-reference">define</span> <span class="enscript-variable-name">__strerror_r</span> strerror_r
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>	<span class="enscript-comment">/* not _LIBC */</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">print_errno_message</span> (<span class="enscript-type">int</span> errnum)
{
  <span class="enscript-type">char</span> <span class="enscript-type">const</span> *s = NULL;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">HAVE_STRERROR_R</span> || <span class="enscript-variable-name">_LIBC</span>
  <span class="enscript-type">char</span> errbuf[1024];
# <span class="enscript-reference">if</span> <span class="enscript-variable-name">STRERROR_R_CHAR_P</span> || <span class="enscript-variable-name">_LIBC</span>
  s = __strerror_r (errnum, errbuf, <span class="enscript-keyword">sizeof</span> errbuf);
# <span class="enscript-reference">else</span>
  <span class="enscript-keyword">if</span> (__strerror_r (errnum, errbuf, <span class="enscript-keyword">sizeof</span> errbuf) == 0)
    s = errbuf;
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">_LIBC</span>
  <span class="enscript-keyword">if</span> (! s &amp;&amp; ! (s = strerror (errnum)))
    s = _(<span class="enscript-string">&quot;Unknown system error&quot;</span>);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
  <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
    {
      __fwprintf (stderr, L<span class="enscript-string">&quot;: %s&quot;</span>, s);
      <span class="enscript-keyword">return</span>;
    }
#<span class="enscript-reference">endif</span>

  fprintf (stderr, <span class="enscript-string">&quot;: %s&quot;</span>, s);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span>
<span class="enscript-function-name">error_tail</span> (<span class="enscript-type">int</span> status, <span class="enscript-type">int</span> errnum, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *message, va_list args)
{
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
  <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
    {
# <span class="enscript-reference">define</span> <span class="enscript-variable-name">ALLOCA_LIMIT</span> 2000
      size_t len = strlen (message) + 1;
      <span class="enscript-type">const</span> wchar_t *wmessage = L<span class="enscript-string">&quot;out of memory&quot;</span>;
      wchar_t *wbuf = (len &lt; ALLOCA_LIMIT
		       ? alloca (len * <span class="enscript-keyword">sizeof</span> *wbuf)
		       : len &lt;= SIZE_MAX / <span class="enscript-keyword">sizeof</span> *wbuf
		       ? malloc (len * <span class="enscript-keyword">sizeof</span> *wbuf)
		       : NULL);

      <span class="enscript-keyword">if</span> (wbuf)
	{
	  size_t res;
	  mbstate_t st;
	  <span class="enscript-type">const</span> <span class="enscript-type">char</span> *tmp = message;
	  memset (&amp;st, <span class="enscript-string">'\0'</span>, <span class="enscript-keyword">sizeof</span> (st));
	  res = mbsrtowcs (wbuf, &amp;tmp, len, &amp;st);
	  wmessage = res == (size_t) -1 ? L<span class="enscript-string">&quot;???&quot;</span> : wbuf;
	}

      __vfwprintf (stderr, wmessage, args);
      <span class="enscript-keyword">if</span> (! (len &lt; ALLOCA_LIMIT))
	free (wbuf);
    }
  <span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span>
    vfprintf (stderr, message, args);
  va_end (args);

  ++error_message_count;
  <span class="enscript-keyword">if</span> (errnum)
    print_errno_message (errnum);
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
  <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
    putwc (L<span class="enscript-string">'\n'</span>, stderr);
  <span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span>
    putc (<span class="enscript-string">'\n'</span>, stderr);
  fflush (stderr);
  <span class="enscript-keyword">if</span> (status)
    exit (status);
}


<span class="enscript-comment">/* Print the program name and error message MESSAGE, which is a printf-style
   format string with optional args.
   If ERRNUM is nonzero, print its corresponding system error message.
   Exit with status STATUS if it is nonzero.  */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">error</span> (<span class="enscript-type">int</span> status, <span class="enscript-type">int</span> errnum, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *message, ...)
{
  va_list args;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">_LIBC</span> &amp;&amp; <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__libc_ptf_call</span>
  <span class="enscript-comment">/* We do not want this call to be cut short by a thread
     cancellation.  Therefore disable cancellation for now.  */</span>
  <span class="enscript-type">int</span> state = PTHREAD_CANCEL_ENABLE;
  __libc_ptf_call (pthread_setcancelstate, (PTHREAD_CANCEL_DISABLE, &amp;state),
		   0);
#<span class="enscript-reference">endif</span>

  fflush (stdout);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
  _IO_flockfile (stderr);
#<span class="enscript-reference">endif</span>
  <span class="enscript-keyword">if</span> (error_print_progname)
    (*error_print_progname) ();
  <span class="enscript-keyword">else</span>
    {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
      <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
	__fwprintf (stderr, L<span class="enscript-string">&quot;%s: &quot;</span>, program_name);
      <span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span>
	fprintf (stderr, <span class="enscript-string">&quot;%s: &quot;</span>, program_name);
    }

  va_start (args, message);
  error_tail (status, errnum, message, args);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
  _IO_funlockfile (stderr);
# <span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__libc_ptf_call</span>
  __libc_ptf_call (pthread_setcancelstate, (state, NULL), 0);
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>
}

<span class="enscript-comment">/* Sometimes we want to have at most one error per line.  This
   variable controls whether this mode is selected or not.  */</span>
<span class="enscript-type">int</span> error_one_per_line;

<span class="enscript-type">void</span>
<span class="enscript-function-name">error_at_line</span> (<span class="enscript-type">int</span> status, <span class="enscript-type">int</span> errnum, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *file_name,
	       <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> line_number, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *message, ...)
{
  va_list args;

  <span class="enscript-keyword">if</span> (error_one_per_line)
    {
      <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *old_file_name;
      <span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> old_line_number;

      <span class="enscript-keyword">if</span> (old_line_number == line_number
	  &amp;&amp; (file_name == old_file_name
	      || strcmp (old_file_name, file_name) == 0))
	<span class="enscript-comment">/* Simply return and print nothing.  */</span>
	<span class="enscript-keyword">return</span>;

      old_file_name = file_name;
      old_line_number = line_number;
    }

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">_LIBC</span> &amp;&amp; <span class="enscript-variable-name">defined</span> <span class="enscript-variable-name">__libc_ptf_call</span>
  <span class="enscript-comment">/* We do not want this call to be cut short by a thread
     cancellation.  Therefore disable cancellation for now.  */</span>
  <span class="enscript-type">int</span> state = PTHREAD_CANCEL_ENABLE;
  __libc_ptf_call (pthread_setcancelstate, (PTHREAD_CANCEL_DISABLE, &amp;state),
		   0);
#<span class="enscript-reference">endif</span>

  fflush (stdout);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
  _IO_flockfile (stderr);
#<span class="enscript-reference">endif</span>
  <span class="enscript-keyword">if</span> (error_print_progname)
    (*error_print_progname) ();
  <span class="enscript-keyword">else</span>
    {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
      <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
	__fwprintf (stderr, L<span class="enscript-string">&quot;%s: &quot;</span>, program_name);
      <span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span>
	fprintf (stderr, <span class="enscript-string">&quot;%s:&quot;</span>, program_name);
    }

  <span class="enscript-keyword">if</span> (file_name != NULL)
    {
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_LIBC</span>
      <span class="enscript-keyword">if</span> (_IO_fwide (stderr, 0) &gt; 0)
	__fwprintf (stderr, L<span class="enscript-string">&quot;%s:%d: &quot;</span>, file_name, line_number);
      <span class="enscript-keyword">else</span>
#<span class="enscript-reference">endif</span>
	fprintf (stderr, <span class="enscript-string">&quot;%s:%d: &quot;</span>, file_name, line_number);
    }

  va_start (args, message);
  error_tail (status, errnum, message, args);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
  _IO_funlockfile (stderr);
# <span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__libc_ptf_call</span>
  __libc_ptf_call (pthread_setcancelstate, (state, NULL), 0);
# <span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>
}

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_LIBC</span>
<span class="enscript-comment">/* Make the weak alias.  */</span>
# <span class="enscript-reference">undef</span> <span class="enscript-variable-name">error</span>
# <span class="enscript-reference">undef</span> <span class="enscript-variable-name">error_at_line</span>
<span class="enscript-function-name">weak_alias</span> (__error, error)
<span class="enscript-function-name">weak_alias</span> (__error_at_line, error_at_line)
#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>