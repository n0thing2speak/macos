<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>johab.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">johab.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="?txt">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (C) 1999-2001 Free Software Foundation, Inc.
 * This file is part of the GNU LIBICONV Library.
 *
 * The GNU LIBICONV Library is free software; you can redistribute it
 * and/or modify it under the terms of the GNU Library General Public
 * License as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * The GNU LIBICONV Library is distributed in the hope that it will be
 * useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Library General Public License for more details.
 *
 * You should have received a copy of the GNU Library General Public
 * License along with the GNU LIBICONV Library; see the file COPYING.LIB.
 * If not, write to the Free Software Foundation, Inc., 51 Franklin Street,
 * Fifth Floor, Boston, MA 02110-1301, USA.
 */</span>

<span class="enscript-comment">/*
 * JOHAB
 */</span>

<span class="enscript-comment">/*
   Conversion between JOHAB codes (s1,s2) and KSX1001 codes (c1,c2):
   Example. (s1,s2) = 0xD931, (c1,c2) = 0x2121.
            (s1,s2) = 0xDEF1, (c1,c2) = 0x2C71.
            (s1,s2) = 0xE031, (c1,c2) = 0x4A21.
            (s1,s2) = 0xF9FE, (c1,c2) = 0x7D7E.
   0xD9 &lt;= s1 &lt;= 0xDE || 0xE0 &lt;= s1 &lt;= 0xF9,
   0x31 &lt;= s2 &lt;= 0x7E || 0x91 &lt;= s2 &lt;= 0xFE,
   0x21 &lt;= c1 &lt;= 0x2C || 0x4A &lt;= c1 &lt;= 0x7D,
   0x21 &lt;= c2 &lt;= 0x7E.
   Invariant:
     94*(s1 &lt; 0xE0 ? 2*s1-0x1B2 : 2*s1-0x197) + (s2 &lt; 0x91 ? s2-0x31 : s2-0x43)
     = 94*(c1-0x21)+(c2-0x21)
   Conversion (s1,s2) -&gt; (c1,c2):
     t1 := (s1 &lt; 0xE0 ? 2*s1-0x1B2 : 2*s1-0x197)
     t2 := (s2 &lt; 0x91 ? s2-0x31 : s2-0x43)
     c1 := t1 + (t2 &lt; 0x5E ? 0 : 1) + 0x21
     c2 := (t2 &lt; 0x5E ? t2 : t2-0x5E) + 0x21
   Conversion (c1,c2) -&gt; (s1,s2):
     t := (c1 &lt; 0x4A ? (c1-0x21+0x1B2) : (c1-0x21+0x197))
     s1 := t &gt;&gt; 1
     t2 := (t &amp; 1) * 0x5E + (c2 - 0x21)
     s2 := (t2 &lt; 0x4E ? t2+0x31 : t2+0x43)
 */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">johab_mbtowc</span> (conv_t conv, ucs4_t *pwc, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *s, size_t n)
{
  <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> c = *s;
  <span class="enscript-keyword">if</span> (c &lt; 0x80) {
    <span class="enscript-keyword">if</span> (c == 0x5c)
      *pwc = (ucs4_t) 0x20a9;
    <span class="enscript-keyword">else</span>
      *pwc = (ucs4_t) c;
    <span class="enscript-keyword">return</span> 1;
  } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (c &lt; 0xd8) {
    <span class="enscript-keyword">return</span> johab_hangul_mbtowc(conv,pwc,s,n);
  } <span class="enscript-keyword">else</span> {
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> s1, s2;
    s1 = c;
    <span class="enscript-keyword">if</span> ((s1 &gt;= 0xd9 &amp;&amp; s1 &lt;= 0xde) || (s1 &gt;= 0xe0 &amp;&amp; s1 &lt;= 0xf9)) {
      <span class="enscript-keyword">if</span> (n &lt; 2)
        <span class="enscript-keyword">return</span> RET_TOOFEW(0);
      s2 = s[1];
      <span class="enscript-keyword">if</span> ((s2 &gt;= 0x31 &amp;&amp; s2 &lt;= 0x7e) || (s2 &gt;= 0x91 &amp;&amp; s2 &lt;= 0xfe)) {
        <span class="enscript-comment">/* In KSC 5601, the region s1 = 0xDA, 0xA1 &lt;= s2 &lt;= 0xD3 contains
           the 51 Jamo (Hangul letters). But in the Johab encoding, they
           have been moved to the Hangul section, see johab_hangul_page31. */</span>
        <span class="enscript-keyword">if</span> (!(s1 == 0xda &amp;&amp; (s2 &gt;= 0xa1 &amp;&amp; s2 &lt;= 0xd3))) {
          <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> t1 = (s1 &lt; 0xe0 ? 2*(s1-0xd9) : 2*s1-0x197);
          <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> t2 = (s2 &lt; 0x91 ? s2-0x31 : s2-0x43);
          <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> buf[2];
          buf[0] = t1 + (t2 &lt; 0x5e ? 0 : 1) + 0x21;
          buf[1] = (t2 &lt; 0x5e ? t2 : t2-0x5e) + 0x21;
          <span class="enscript-keyword">return</span> ksc5601_mbtowc(conv,pwc,buf,2);
        }
      }
    }
    <span class="enscript-keyword">return</span> RET_ILSEQ;
  }
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">johab_wctomb</span> (conv_t conv, <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *r, ucs4_t wc, size_t n)
{
  <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> buf[2];
  <span class="enscript-type">int</span> ret;

  <span class="enscript-comment">/* Try ASCII variation. */</span>
  <span class="enscript-keyword">if</span> (wc &lt; 0x0080 &amp;&amp; wc != 0x005c) {
    *r = wc;
    <span class="enscript-keyword">return</span> 1;
  }
  <span class="enscript-keyword">if</span> (wc == 0x20a9) {
    *r = 0x5c;
    <span class="enscript-keyword">return</span> 1;
  }

  <span class="enscript-comment">/* Try JOHAB Hangul table before KSC5601 table, because the KSC5601 table
     contains some (2350 out of 11172) Hangul syllables (rows 0x30XX..0x48XX),
     and we want the search to return the JOHAB Hangul table entry. */</span>

  <span class="enscript-comment">/* Try JOHAB Hangul. */</span>
  ret = johab_hangul_wctomb(conv,buf,wc,2);
  <span class="enscript-keyword">if</span> (ret != RET_ILUNI) {
    <span class="enscript-keyword">if</span> (ret != 2) abort();
    <span class="enscript-keyword">if</span> (n &lt; 2)
      <span class="enscript-keyword">return</span> RET_TOOSMALL;
    r[0] = buf[0];
    r[1] = buf[1];
    <span class="enscript-keyword">return</span> 2;
  }

  <span class="enscript-comment">/* Try KSC5601. */</span>
  ret = ksc5601_wctomb(conv,buf,wc,2);
  <span class="enscript-keyword">if</span> (ret != RET_ILUNI) {
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> c1, c2;
    <span class="enscript-keyword">if</span> (ret != 2) abort();
    <span class="enscript-keyword">if</span> (n &lt; 2)
      <span class="enscript-keyword">return</span> RET_TOOSMALL;
    c1 = buf[0];
    c2 = buf[1];
    <span class="enscript-keyword">if</span> (((c1 &gt;= 0x21 &amp;&amp; c1 &lt;= 0x2c) || (c1 &gt;= 0x4a &amp;&amp; c1 &lt;= 0x7d))
        &amp;&amp; (c2 &gt;= 0x21 &amp;&amp; c2 &lt;= 0x7e)) {
      <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> t = (c1 &lt; 0x4A ? (c1-0x21+0x1B2) : (c1-0x21+0x197));
      <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> t2 = ((t &amp; 1) ? 0x5e : 0) + (c2 - 0x21);
      r[0] = t &gt;&gt; 1;
      r[1] = (t2 &lt; 0x4e ? t2+0x31 : t2+0x43);
      <span class="enscript-keyword">return</span> 2;
    }
  }

  <span class="enscript-keyword">return</span> RET_ILUNI;
}
</pre>
<hr />
</body></html>